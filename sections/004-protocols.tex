\section{Protocols and Composition}

\begin{definition}[Open Protocols]
An \emph{open protocol} $\mathcal{P}$ consists of:
\begin{itemize}
\item Systems $P_1, \ldots, P_n$, called \emph{players}
\item A package $F$, called the \emph{ideal functionality}
\end{itemize}

Furthermore, we also impose requirements on the channels and functions
these elements use.

First, we require that the player systems are jointly closed,
with no extra channels that aren't connected to other players:
$$
\bigcup_{i \in [n]} \text{OutChan}(P_i) = \bigcup_{i \in [n]} \text{InChan}(P_i)
$$

Second, we require that the functions the systems depend on are disjoint:
$$
\forall i, j \in [n].\quad \text{In}(P_i) \cap \text{In}(P_j) = \emptyset
$$

Third, we require that the functions the systems export on are disjoint:
$$
\forall i, j \in [n].\quad \text{Out}(P_i) \cap \text{Out}(P_j) = \emptyset
$$

We can also define a few convenient notations related to the interface of a base
protocol.

Let $\text{Out}_i(\mathcal{P}) := \text{Out}(P_i)$, and let $\text{In}_i(\mathcal{P}) := \text{In}(P_i) / \text{Out}(F)$.
We then define $\text{Out}(\mathcal{P}) := \bigcup_{i \in [n]} \text{Out}_i(\mathcal{P})$
and $\text{In}(\mathcal{P}) := \bigcup_{i \in [n]} \text{In}_i(\mathcal{P})$.

Finally, we define
$$
\begin{aligned}
&\text{IdealIn}(\mathcal{P}) := \text{In}(F)\cr
&\text{Leakage}(\mathcal{P}) := \text{Out}(F) / \left(\bigcup_{i \in [n]} \tx{In}(P_i)\right)
\end{aligned}
$$

$\square$
\end{definition}

\begin{definition}[Literal Equality]
Given two open protocols $\mathcal{P}$ and $\mathcal{Q}$, we say that
they are \emph{literally equal}, written as $\mathcal{P} \equiv \mathcal{Q}$
when:
\begin{itemize}
\item $\mathcal{P}.n = \mathcal{Q}.n$
\item There exists a permuation $\pi : [n] \leftrightarrow [n]$ such that
$
{\forall i \in [n].\enspace \mathcal{P}.P_i = \mathcal{Q}.P_{\pi(i)}}
$
\item $\mathcal{P}.F = \mathcal{P}.G$
\end{itemize}

$\square$
\end{definition}

\begin{definition}[Vertical Composition]
Given an open protocol $\mathcal{P}$ and a package $G$, satisfying
$\text{IdealIn}(\mathcal{P}) \subseteq \text{Out}(G)$,
we can define the open protocol $\mathcal{P} \circ G$.

$\mathcal{P} \circ G$ has the same players as $\mathcal{P}$,
but its ideal functionality $F$ becomes $F \circ G$.

$\square$
\end{definition}

\begin{claim}[Vertical Composition is Associative]
For any protocol $\mathcal{P}$, and packages $G, H$, such that their composition
is well defined, we have
$$
\mathcal{P} \circ (G \circ H) = (\mathcal{P} \circ G) \circ H
$$

\txbf{Proof:} This follows from the definition of vertical composition
and the associativity of $\circ$ for packages.
$\blacksquare$
\end{claim}

\begin{definition}[Horizontal Composition]
Given two open protocols $\mathcal{P}, \mathcal{Q}$,
we can define the open protocol $\mathcal{P} \lhd \mathcal{Q}$,
provided a few requirements hold.

First, we need: $\text{In}(\mathcal{P}) \subseteq \text{Out}(\mathcal{Q})$.
We also require that the functions exposed by a player in $\mathcal{Q}$
are used by \emph{exactly} one player in $\mathcal{P}$.
We express this as:
\[
  \forall i \in [\mathcal{Q}.n].\ \exists! j \in [\mathcal{P}.n].\quad \text{In}_j \cap \text{Out}_i \neq \emptyset
\]

Second, we require that the players share no channels between the two
protocols.
In other words $\text{Chan}(\mathcal{P}.P_i) \cap \text{Chan}(\mathcal{Q}.P_j) = \emptyset$, for all $P_i, P_j$.

Third, we require that the leakages of one game aren't use in the other:
$$
\begin{aligned}
&\tx{Leakage}(\mathcal{P}) \cap \tx{In}(\mathcal{Q}) = \emptyset\cr
&\tx{Leakage}(\mathcal{Q}) \cap \tx{In}(\mathcal{P}) = \emptyset
\end{aligned}
$$

Finally, we require that the ideal functionalities do not overlap, 
  in the sense that $\text{Out}(\mathcal{P}.F) \cap \text{Out}(\mathcal{Q}.F) = \emptyset$

Our first condition has an interesting consequence: every player $\mathcal{Q}.P_j$
has its functions used by exactly one player $\mathcal{P}.P_i$.
In that case, we say that $\mathcal{P}.P_i$ \emph{uses} $\mathcal{Q}.P_j$.

With this in hand, we can define $\mathcal{P} \lhd \mathcal{Q}$.

The players will consist of:
$$
  \mathcal{P}.P_i \circ \left( \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } \mathcal{Q}.P_j \right)
$$
And, because of our assumption, each player in $\mathcal{Q}$ appears
somewhere in this equation.

The ideal functionality is $\mathcal{P}.F \otimes \mathcal{Q}.F$.

We can also easily show that this definition is well defined, satisfying
the required properties of an open protocol.
Because of the definition of the players, we see that:
$$
  \bigcup_{i \in [(\mathcal{P} \lhd \mathcal{Q}).n]} \tx{OutChan}((\mathcal{P} \lhd \mathcal{Q}).{P_i})
  = \left(\bigcup_{i \in [\mathcal{P}.n]} \tx{OutChan}(\mathcal{P}.P_i)\right) \cup
  \left(\bigcup_{i \in [\mathcal{Q}.n]} \tx{OutChan}(\mathcal{Q}.P_i)\right)
$$
  since $\text{OutChan}(A \circ B) = \text{OutChan}(A \otimes B) = \text{OutChan}(A, B)$.
A similar reasoning applies to $\text{InChan}$, allowing us to conclude that:
$$
  \bigcup_{i \in [(\mathcal{P} \lhd \mathcal{Q}).n]} \tx{OutChan}((\mathcal{P} \lhd \mathcal{Q}).{P_i}) =
  \bigcup_{i \in [(\mathcal{P} \lhd \mathcal{Q}).n]} \tx{InChan}((\mathcal{P} \lhd \mathcal{Q}).{P_i})
$$
as required.

By definition, the dependencies $\text{In}$ of each player in $\mathcal{P} \lhd \mathcal{Q}$
are the union of several players in $\mathcal{Q}$, so disjointness property
continues to hold.

Finally, since each player is of the form $\mathcal{P}.P_i \circ \ldots$,
the condition on $\text{Out}_i$ is also satisfied in $\mathcal{P} \lhd \mathcal{Q}$,
since $\mathcal{P}$ does.

$\square$

\end{definition}

\begin{lemma}
Horizontal composition is associative, i.e.
${\mathcal{P} \lhd (\mathcal{Q} \lhd \mathcal{R}) \equiv (\mathcal{P} \lhd \mathcal{Q}) \lhd \mathcal{R}}$
for all open protocols $\mathcal{P}, \mathcal{Q}, \mathcal{R}$ where this expression is well defined.

$\txbf{Proof:}$
For the ideal functionalities, it's clear that by the associativity
of $\otimes$ for systems, the resulting functionality is the same
in both cases.

The trickier part of the proof is showing that the resulting players
are identical.

It's convenient to define a relation for the players in $\mathcal{R}$
that get used in $\mathcal{P}$ via the players in $\mathcal{Q}$.
To that end, we say that $\mathcal{P}.P_i$ \emph{uses} $\mathcal{R}.P_j$
if there exists $\mathcal{Q}.P_k$ such that $\mathcal{P}.P_i$ uses
$\mathcal{Q}.P_k$, and $\mathcal{Q}.P_k$ uses $\mathcal{R}.P_j$.

The players of $\mathcal{P} \lhd (\mathcal{Q} \lhd \mathcal{R})$ are of the form:
$$
  \mathcal{P}.P_i \circ
  \left( \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } 
  \mathcal{Q}.P_j \circ
  \left( \bigast_{\mathcal{R}.P_k \text{ used by } \mathcal{Q}.P_j } \mathcal{R}.P_k
  \right)
  \right)
$$
While those in $(\mathcal{P} \lhd \mathcal{Q}) \mathcal{R}$ are of the form:
$$
  \left( \mathcal{P}.P_i \circ
  \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } 
  \mathcal{Q}.P_j
  \right)
  \circ
  \left(\bigast_{\mathcal{R}.P_k \text{ used by } \mathcal{P}.P_i } \mathcal{R}.P_k
  \right)
$$
Now, we can apply the associativity of $\circ$ for systems, and also
group the $\mathcal{R}.P_k$ players based on which $\mathcal{Q}.P_j$ uses them:
$$
  \mathcal{P}.P_i \circ
  \left(
  \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } 
  \mathcal{Q}.P_j
  \right)
  \circ
  \left(
    \bigast_{\mathcal{Q}.P_j}
  \left(\bigast_{\mathcal{R}.P_k \text{ used by } \mathcal{Q}.P_j } \mathcal{R}.P_k
  \right)
  \right)
$$
Now, the conditions are satisfied for applying the interchange lemma (Lemma~\ref{thm:interchange_system}),
giving us:
$$
  \mathcal{P}.P_i \circ
  \left( \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } 
  \mathcal{Q}.P_j \circ
  \left( \bigast_{\mathcal{R}.P_k \text{ used by } \mathcal{Q}.P_j } \mathcal{R}.P_k
  \right)
  \right)
$$
Which is non other than the players in $\mathcal{P} \lhd (\mathcal{Q} \lhd \mathcal{R})$.

$\blacksquare$
\end{lemma}

\begin{definition}[Concurrent Composition]
Given two open open protocols $\mathcal{P}, \mathcal{Q}$,
we can define their concurrent composition---or tensor product---
$\mathcal{P} \otimes \mathcal{Q}$, provided a few requirements hold.
We require that:
\begin{enumerate}
\item $\tx{In}(\mathcal{P}) \cap \tx{In}(\mathcal{Q}) = \emptyset$.
\item $\tx{Out}(\mathcal{P}) \cap \tx{Out}(\mathcal{Q}) = \emptyset$.
\item $\tx{Out}(\mathcal{P}.F) \cap \tx{Out}(\mathcal{Q}.F) = \emptyset$ \emph{or} $\mathcal{P}.F = \mathcal{Q}.F$.
\item $\tx{Leakage}(\mathcal{P}) \cap \tx{In}(\mathcal{Q}) = \emptyset = \tx{Leakage}(\mathcal{Q}) \cap \tx{In}(\mathcal{P})$
\end{enumerate}

The players of $\mathcal{P} \otimes \mathcal{Q}$ consist of all the players
in $\mathcal{P}$ and $\mathcal{Q}$.
The ideal functionality is $\mathcal{P}.F \otimes \mathcal{Q}.F$, 
unless $\mathcal{P}.F = \mathcal{Q}.F$, in which case the ideal functionality
is simply $\mathcal{P}.F$.
This use of $\otimes$ is well defined by assumption.

The resulting protocol is also clearly well defined.

The jointly closed property holds because we've simply taken the union
of both player sets.

Since $\tx{In}(\mathcal{P}) \cap \tx{In}(\mathcal{Q}) = \emptyset$,
it also holds that for every $P_i, P_j$ in $\mathcal{P} \otimes \mathcal{Q}$,
we have $\tx{In}(P_i) \cap \tx{In}(P_j) = \emptyset$,
since each player comes from either $\mathcal{P}$ or $\mathcal{Q}$.
      
Finally, $\tx{Out}(\mathcal{P}) \cap \tx{Out}(\mathcal{Q}) = \emptyset$,
we have that $\tx{Out}(P_i) \cap \tx{Out}(P_j) = \emptyset$,
by the same reasoning.
    
$\square$
\end{definition}

\todo{The reason why we allow for $F = G$ is so that you can have like the same $1$}

\begin{lemma}
Concurrent composition is associative and commutative.
I.e. $\mathcal{P} \otimes (\mathcal{Q} \otimes \mathcal{R}) \equiv (\mathcal{P} \otimes \mathcal{Q}) \otimes \mathcal{R}$,
and $\mathcal{P} \otimes \mathcal{Q} \equiv \mathcal{Q} \otimes \mathcal{P}$ for
all open protocols $\mathcal{P}, \mathcal{Q}, \mathcal{R}$ where these expressions
are well defined.

\txbf{Proof:}

By the definition of $\equiv$, all that matter is the \emph{set} of players,
and not their order.
Because $\cup$ is associative, and so is $\otimes$ for systems,
we conclude that concurrent composition is associative as well,
since the resulting set of players and ideal functionality are the same
in both cases.

Similarly, since $\cup$ and $\otimes$ (for systems) are commutative,
we conclude that concurrenty composition is commutative.

$\blacksquare$
\end{lemma}
