\section{Protocols and Composition}

\begin{definition}[Protocols]
A \emph{protocol} $\mathcal{P}$ consists of:
\begin{itemize}
\item Systems $P_1, \ldots, P_n$, called \emph{players}
\item An asynchronous package $F$, called the \emph{ideal functionality}
\item A set $\tx{Leakage} \subseteq \tx{Out}(F)$, called the leakage
\end{itemize}

Furthermore, we also impose requirements on the channels and functions
these elements use.

First, we require that the player systems are jointly closed,
with no extra channels that aren't connected to other players:
$$
\bigcup_{i \in [n]} \text{OutChan}(P_i) = \bigcup_{i \in [n]} \text{InChan}(P_i)
$$

Second, we require that the functions the systems depend on are disjoint,
outside of the ideal functionality:
$$
\forall i, j \in [n].\quad \text{In}(P_i) \cap \text{In}(P_j) \subseteq \tx{Out}(F)
$$

Third, we require that the functions the systems export on are disjoint:
$$
\forall i, j \in [n].\quad \text{Out}(P_i) \cap \text{Out}(P_j) = \emptyset
$$

We can also define a few convenient notations related to the interface of a base
protocol.

Let $\text{Out}_i(\mathcal{P}) := \text{Out}(P_i)$, and let $\text{In}_i(\mathcal{P}) := \text{In}(P_i) / \text{Out}(F)$.
We then define $\text{Out}(\mathcal{P}) := \bigcup_{i \in [n]} \text{Out}_i(\mathcal{P})$
and $\text{In}(\mathcal{P}) := \bigcup_{i \in [n]} \text{In}_i(\mathcal{P})$.
Let $\tx{IdealIn}_i(\mathcal{P}) := \tx{In}(P_i) \cap \tx{Out}(F)$.

Finally, we define
$$
\begin{aligned}
&\text{IdealIn}(\mathcal{P}) := \text{In}(F)\cr
\end{aligned}
$$

$\square$
\end{definition}

\begin{definition}[Closed Protocol]
  We say that a protocol $\mathcal{P}$ is \emph{closed} if
  $\tx{In}(\mathcal{P}) = \emptyset$ and $\tx{IdealIn}(\mathcal{P}) = \emptyset$.

  $\square$
\end{definition}

\begin{definition}[Literal Equality]
Given two protocols $\mathcal{P}$ and $\mathcal{Q}$, we say that
they are \emph{literally equal}, written as $\mathcal{P} \equiv \mathcal{Q}$
when:
\begin{itemize}
\item $\mathcal{P}.n = \mathcal{Q}.n$
\item There exists a permuation $\pi : [n] \leftrightarrow [n]$ such that
$
{\forall i \in [n].\enspace \mathcal{P}.P_i \equiv \mathcal{Q}.P_{\pi(i)}}
$
\item $\mathcal{P}.F = \mathcal{Q}.F$
\item $\mathcal{P}.\tx{Leakage} = \mathcal{Q}.\tx{Leakage}$
\end{itemize}

$\square$
\end{definition}

\begin{definition}[Vertical Composition]
Given an protocol $\mathcal{P}$ and a package $G$, satisfying
$\text{IdealIn}(\mathcal{P}) \subseteq \text{Out}(G)$,
we can define the protocol $\mathcal{P} \circ G$.

$\mathcal{P} \circ G$ has the same players and leakage as $\mathcal{P}$,
but its ideal functionality $F$ becomes $F \circ G$.

$\square$
\end{definition}

\begin{claim}[Vertical Composition is Associative]
For any protocol $\mathcal{P}$, and packages $G, H$, such that their composition
is well defined, we have
$$
\mathcal{P} \circ (G \circ H) = (\mathcal{P} \circ G) \circ H
$$

\txbf{Proof:} This follows from the definition of vertical composition
and the associativity of $\circ$ for packages.
$\blacksquare$
\end{claim}

\begin{definition}[Horizontal Composition]
Given two protocols $\mathcal{P}, \mathcal{Q}$,
we can define the protocol $\mathcal{P} \lhd \mathcal{Q}$,
provided a few requirements hold.

First, we need: $\text{In}(\mathcal{P}) \subseteq \text{Out}(\mathcal{Q})$.
We also require that the functions exposed by a player in $\mathcal{Q}$
are used by \emph{exactly} one player in $\mathcal{P}$.
We express this as:
\[
  \forall i \in [\mathcal{Q}.n].\ \exists! j \in [\mathcal{P}.n].\quad \text{In}_j \cap \text{Out}_i \neq \emptyset
\]

Second, we require that the players share no channels between the two
protocols.
In other words $\text{Chan}(\mathcal{P}.P_i) \cap \text{Chan}(\mathcal{Q}.P_j) = \emptyset$, for all $P_i, P_j$.

Third, we require that the ideal functionalities of one protocol aren't used in the other.
$$
\begin{aligned}
&\tx{Out}(\mathcal{P}.F) \cap \tx{In}(\mathcal{Q}) = \emptyset\cr
&\tx{Out}(\mathcal{Q}.F) \cap \tx{In}(\mathcal{P}) = \emptyset
\end{aligned}
$$

Finally, we require that the ideal functionalities do not overlap, 
  in the sense that $\text{Out}(\mathcal{P}.F) \cap \text{Out}(\mathcal{Q}.F) = \emptyset$

Our first condition has an interesting consequence: every player $\mathcal{Q}.P_j$
has its functions used by exactly one player $\mathcal{P}.P_i$.
In that case, we say that $\mathcal{P}.P_i$ \emph{uses} $\mathcal{Q}.P_j$.

With this in hand, we can define $\mathcal{P} \lhd \mathcal{Q}$.

The players will consist of:
$$
  \mathcal{P}.P_i \circ
  \begin{pmatrix}
    {\displaystyle \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } \mathcal{Q}.P_j} \cr
    \otimes\cr
    1(\tx{IdealIn}_i)
  \end{pmatrix}
$$
And, because of our assumption, each player in $\mathcal{Q}$ appears
somewhere in this equation.

The ideal functionality is $\mathcal{P}.F \otimes \mathcal{Q}.F$,
and the leakage is $\mathcal{P}.\tx{Leakage} \cup \mathcal{Q}.\tx{Leakage}$.

We can also easily show that this definition is well defined, satisfying
the required properties of an protocol.
Because of the definition of the players, we see that:
$$
  \bigcup_{i \in [(\mathcal{P} \lhd \mathcal{Q}).n]} \tx{OutChan}((\mathcal{P} \lhd \mathcal{Q}).{P_i})
  = \left(\bigcup_{i \in [\mathcal{P}.n]} \tx{OutChan}(\mathcal{P}.P_i)\right) \cup
  \left(\bigcup_{i \in [\mathcal{Q}.n]} \tx{OutChan}(\mathcal{Q}.P_i)\right)
$$
  since $\text{OutChan}(A \circ B) = \text{OutChan}(A \otimes B) = \text{OutChan}(A, B)$.
A similar reasoning applies to $\text{InChan}$, allowing us to conclude that:
$$
  \bigcup_{i \in [(\mathcal{P} \lhd \mathcal{Q}).n]} \tx{OutChan}((\mathcal{P} \lhd \mathcal{Q}).{P_i}) =
  \bigcup_{i \in [(\mathcal{P} \lhd \mathcal{Q}).n]} \tx{InChan}((\mathcal{P} \lhd \mathcal{Q}).{P_i})
$$
as required.

By definition, the dependencies $\text{In}$ of each player in $\mathcal{P} \lhd \mathcal{Q}$
are the union of several players in $\mathcal{Q}$, and
the ideal dependencies of players in $\mathcal{P}$,
both of these are required to be disjoint, so disjointness property
continues to hold.

Finally, since each player is of the form $\mathcal{P}.P_i \circ \ldots$,
the condition on $\text{Out}_i$ is also satisfied in $\mathcal{P} \lhd \mathcal{Q}$,
since $\mathcal{P}$ does.

$\square$

\end{definition}

\begin{lemma}
Horizontal composition is associative, i.e.
${\mathcal{P} \lhd (\mathcal{Q} \lhd \mathcal{R}) \equiv (\mathcal{P} \lhd \mathcal{Q}) \lhd \mathcal{R}}$
for all protocols $\mathcal{P}, \mathcal{Q}, \mathcal{R}$ where this expression is well defined.

$\txbf{Proof:}$
For the ideal functionalities, it's clear that by the associativity
of $\otimes$ for systems, the resulting functionality is the same
in both cases.

The trickier part of the proof is showing that the resulting players
are identical.

It's convenient to define a relation for the players in $\mathcal{R}$
that get used in $\mathcal{P}$ via the players in $\mathcal{Q}$.
To that end, we say that $\mathcal{P}.P_i$ \emph{uses} $\mathcal{R}.P_j$
if there exists $\mathcal{Q}.P_k$ such that $\mathcal{P}.P_i$ uses
$\mathcal{Q}.P_k$, and $\mathcal{Q}.P_k$ uses $\mathcal{R}.P_j$.

The players of $\mathcal{P} \lhd (\mathcal{Q} \lhd \mathcal{R})$ are of the form:
$$
  \mathcal{P}.P_i \circ
  \begin{pmatrix}
  \displaystyle \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } 
  \mathcal{Q}.P_j \circ
  \begin{pmatrix}
  \displaystyle \bigast_{\mathcal{R}.P_k \text{ used by } \mathcal{Q}.P_j } \mathcal{R}.P_k\cr
  \otimes\cr
  1(\mathcal{Q}.\tx{IdealIn}_j)
  \end{pmatrix}\cr
  \otimes\cr
  1(\mathcal{P}.\tx{IdealIn}_i)
  \end{pmatrix}
$$
While those in $(\mathcal{P} \lhd \mathcal{Q}) \mathcal{R}$ are of the form:
$$
  \left( \mathcal{P}.P_i \circ
  \begin{pmatrix}
  \displaystyle \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } 
  \mathcal{Q}.P_j\cr
  \otimes\cr
  1(\mathcal{P}.\tx{IdealIn}_i)
  \end{pmatrix}
  \right)
  \circ
  \begin{pmatrix}
    \displaystyle \bigast_{\mathcal{R}.P_k \text{ used by } \mathcal{P}.P_i } \mathcal{R}.P_k\cr
  \otimes\cr
  1(\mathcal{Q}.\tx{IdealIn}_j)
  \end{pmatrix}
$$
Now, we can apply the associativity of $\circ$ for systems, and also
group the $\mathcal{R}.P_k$ players based on which $\mathcal{Q}.P_j$ uses them:
$$
  \mathcal{P}.P_i \circ
  \begin{pmatrix}
  \displaystyle \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } 
  \mathcal{Q}.P_j\cr
  \otimes\cr
  1(\mathcal{P}.\tx{IdealIn}_i)
  \end{pmatrix}
  \circ
  \left(
    \displaystyle \bigast_{\mathcal{Q}.P_j}
  \begin{pmatrix}
  \displaystyle \bigast_{\mathcal{R}.P_k \text{ used by } \mathcal{Q}.P_j } \mathcal{R}.P_k
  \cr
  \otimes\cr
  1(\mathcal{Q}.\tx{IdealIn}_j)
  \end{pmatrix}
  \right)
$$
Now, the conditions are satisfied for applying the interchange lemma (Lemma~\ref{thm:interchange_system}),
giving us:
$$
  \mathcal{P}.P_i \circ
  \begin{pmatrix}
  \displaystyle \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } 
  \mathcal{Q}.P_j \circ
  \begin{pmatrix}
  \displaystyle \bigast_{\mathcal{R}.P_k \text{ used by } \mathcal{Q}.P_j } \mathcal{R}.P_k\cr
  \otimes\cr
  1(\mathcal{Q}.\tx{IdealIn}_j)
  \end{pmatrix}\cr
  \otimes\cr
  1(\mathcal{P}.\tx{IdealIn}_i)
  \end{pmatrix}
$$
Which is non other than the players in $\mathcal{P} \lhd (\mathcal{Q} \lhd \mathcal{R})$.

$\blacksquare$
\end{lemma}

\begin{definition}[Concurrent Composition]
Given two protocols $\mathcal{P}, \mathcal{Q}$,
we can define their concurrent composition---or tensor product---
$\mathcal{P} \otimes \mathcal{Q}$, provided a few requirements hold.
We require that:
\begin{enumerate}
\item $\tx{In}(\mathcal{P}) \cap \tx{In}(\mathcal{Q}) = \emptyset$.
\item $\tx{Out}(\mathcal{P}) \cap \tx{Out}(\mathcal{Q}) = \emptyset$.
\item $\tx{Out}(\mathcal{P}.F) \cap \tx{Out}(\mathcal{Q}.F) = \emptyset$ \emph{or} $\mathcal{P}.F = \mathcal{Q}.F$.
\item $\tx{Leakage}(\mathcal{P}) \cap \tx{In}(\mathcal{Q}) = \emptyset = \tx{Leakage}(\mathcal{Q}) \cap \tx{In}(\mathcal{P})$
\end{enumerate}

The players of $\mathcal{P} \otimes \mathcal{Q}$ consist of all the players
in $\mathcal{P}$ and $\mathcal{Q}$.
The ideal functionality is $\mathcal{P}.F \otimes \mathcal{Q}.F$, 
unless $\mathcal{P}.F = \mathcal{Q}.F$, in which case the ideal functionality
is simply $\mathcal{P}.F$.
In either case, the leakage is $\mathcal{P}.\tx{Leakage} \cup \mathcal{Q}.\tx{Leakage}$.
This use of $\otimes$ is well defined by assumption.

The resulting protocol is also clearly well defined.

The jointly closed property holds because we've simply taken the union
of both player sets.

Since $\tx{In}(\mathcal{P}) \cap \tx{In}(\mathcal{Q}) = \emptyset$,
it also holds that for every $P_i, P_j$ in $\mathcal{P} \otimes \mathcal{Q}$,
we have $\tx{In}(P_i) \cap \tx{In}(P_j) = \emptyset$,
since each player comes from either $\mathcal{P}$ or $\mathcal{Q}$.
      
Finally, $\tx{Out}(\mathcal{P}) \cap \tx{Out}(\mathcal{Q}) = \emptyset$,
we have that $\tx{Out}(P_i) \cap \tx{Out}(P_j) = \emptyset$,
by the same reasoning.
    
$\square$
\end{definition}

\todo{The reason why we allow for $F = G$ is so that you can have like the same $1$}

\begin{lemma}
Concurrent composition is associative and commutative.
I.e. $\mathcal{P} \otimes (\mathcal{Q} \otimes \mathcal{R}) \equiv (\mathcal{P} \otimes \mathcal{Q}) \otimes \mathcal{R}$,
and $\mathcal{P} \otimes \mathcal{Q} \equiv \mathcal{Q} \otimes \mathcal{P}$ for
all protocols $\mathcal{P}, \mathcal{Q}, \mathcal{R}$ where these expressions
are well defined.

\txbf{Proof:}

By the definition of $\equiv$, all that matter is the \emph{set} of players,
and not their order.
Because $\cup$ is associative, and so is $\otimes$ for systems,
we conclude that concurrent composition is associative as well,
since the resulting set of players and ideal functionality are the same
in both cases.

Similarly, since $\cup$ and $\otimes$ (for systems) are commutative,
we conclude that concurrenty composition is commutative.

$\blacksquare$
\end{lemma}

\subsection{Corruption and Simulation}

\begin{definition}[``Honest'' Corruption]
Given a system $P$,
we define the ``honest'' corruption of $P$
$$
\tx{Corrupt}_H(P) := P
$$

This is clearly equality preserving, by tautology.

$\square$
\end{definition}

\begin{definition}[Semi-Honest Corruption]
Given a system $P$, we can define
the semi-honest corruption $\tx{Corrupt}_{\tx{SH}}(P)$.

This is a transformation of
of $P$, providing access to its ``view''.
More formally, $\tx{Corrupt}_{\tx{SH}}(P)$ is a system which works the same
as $P$, but with an additional public variable $\tx{log}$,
which contains several sub logs:
\begin{enumerate}
  \item $\tx{log}.{A_i}$ for each sending channel $A_i$,
  \item $\tx{log}.{B_i}$ for each receiving channel $B_i$,
  \item $\tx{log}.F$ for each input function $F$.
  \item $\tx{log}.G$ for each output function $G$.
\end{enumerate}
Each of these sub logs is initialized with ${\tx{log}.\bullet \gets \tx{FifoQueue.New()}}$.
Additionally, $\tx{Corrupt}_{\tx{SH}}(P)$ modifies $P$ by pushing events to these
logs at different points in time.
These events are:
\begin{itemize}
\item $(\texttt{call}, (x_1, \ldots, x_n))$ to $\tx{log}.F$ when a function call $F(x_1, \ldots, x_n)$ happens.
\item $(\texttt{ret}, y)$ to $\tx{log}.F$ when the function $F$ returns a value $y$.
\item $(\texttt{input}, (x_1, \ldots, x_n))$ to $\tx{log}.G$ when the function $G$ is called with $(x_i, \ldots)$ as input.
\item $m$ to $\tx{log}.A$ when a value $m$ is sent on channel $A$.
\item $m$ to $\tx{log}.B$ when a value $m$ is received on channel $B$.
\end{itemize}

This transformation is also equality respecting.
First, note that if $P \equiv P'$ as systems, then
then $\tx{NoChan}(P) = \tx{NoChan}(P')$, and so their logs will be the same.

$\square$
\end{definition}

\begin{definition}[Malicious Corruption]
Given a system $P$ with:
$$
\begin{aligned}
  &\tx{In}(P) = \{F_1, \ldots, F_n\}\cr
  &\tx{OutChan}(P) = \{A_1, \ldots, A_m\}\cr
  &\tx{InChan}(P) = \{B_1, \ldots, B_l\}\cr
\end{aligned}
$$
we define the malicious corruption $\tx{Corrupt}_M(P)$ as the following game:
\package{$\tx{Corrupt}_M(P)$}{
&\underline{\tx{Call}_{F_i}((x_1, \ldots, x_n))\tx{:}}\cr
\pind{1} \preturn{F_i(x_1, \ldots, x_n)}\cr
\cr
&\underline{\tx{Send}_{A_i}(m)\tx{:}}\cr
\pind{1} \psend{m}{A_i}\cr
\cr
&\underline{\tx{Test}_{B_i}()\tx{:}}\cr
\pind{1} \preturn{\txbf{test } B_i}\cr
\cr
&\underline{\tx{Recv}_{B_i}()\tx{:}}\cr
\pind{1} \preturn{\precv{m}{B_i}}\cr
}

In other words, malicious corruption provides access to the functions
and channels used by $P$, but no more than that.

This is also equality preserving, since $\tx{Corrupt}_M(P)$ depends
only on the channels used by $P$ and the functions called by $P$,
all of which are the same for any $P' \equiv P$.

$\square$
\end{definition}

\begin{lemma}[Simulating Corruptions]
  \label{thm:simulatingcorruption}
  We can simulate corruptions using strong forms of corruption.
  In particular, there exists systems $S_{\tx{SH}}$ and $S_{\tx{H}}$ such that
  for all systems $P$, we have:
  \[
    \begin{aligned}
      &\tx{Corrupt}_{\tx{SH}}(P) = S_{\tx{SH}} \circ \tx{Corrupt}_M(P)\cr
      &\tx{Corrupt}_{\tx{H}}(P) = S_{\tx{H}} \circ \tx{Corrupt}_{\tx{SH}}(P)
    \end{aligned}
  \]

\txbf{Proof:}
For the simulation of honest corruption, we can simply ignore
  the additional log variable, and set $S_{\tx{H}} := 1(\tx{Out}(P))$.

For semi-honest corruption, $S_{\tx{SH}}$ is formed by first transforming
$\tx{Corrupt}_{\tx{SH}}(P)$, replacing:
\begin{itemize}
  \item every function call with $\tx{Call}_{F_i}(\ldots)$,
  \item every sending of a message $m$ on $A$ with $\tx{Send}_A(m)$,
  \item every length test of $B$ with $\tx{Test}_B()$,
  \item every reception of a message on $B$ with $\tx{Recv}_B()$.
\end{itemize}

The result is clearly a perfect emulation of semi-honest corruption
using malicious corruption.

$\blacksquare$
\end{lemma}

Sometimes, it's useful to be able to talk about corruptions in general,
in which case we write $\text{Corrupt}_\kappa(P)$,
for $\kappa \in \{\tx{H}, \tx{SH}, \tx{M}\}$.

\begin{definition}[Corruption Models]
Given a protocol $\mathcal{P}$ with players $P_1, \ldots, P_n$, a \emph{corruption model} $C$
is a function $C : [\mathcal{P}.n] \to \{\tx{H}, \tx{SH}, \tx{M}\}$.
This provides a corruption $C_i$ associated with each player $P_i$.
We can then define $\text{Corrupt}_C(P_i) := \text{Corrupt}_{C_i}(P_i)$.

Corruption models have a natural partial order associated with them. 
We have:
$$
\tx{H} < \tx{SH} < \tx{M}
$$
  and then we say that $C \geq C'$ if $\forall i \in [n]. \quad C_i \geq C'_i$.

A \emph{class of corruptions} $\mathcal{C}$ is simply a set of corruption models.

$\square$
\end{definition}

Some common classes are:
\begin{itemize}
  \item The class of malicious corruptions, where all but one player is malicious.
  \item The class of malicious corruptions, where all but one player is semi-honest.
\end{itemize}

\begin{definition}[Instantiation]
  Given a protocol $\mathcal{P}$ with $\tx{In}(\mathcal{P}) = \emptyset$, and a corruption model $C$, we can
  define an \emph{instantiation} $\tx{Inst}_C(\mathcal{P})$, which
  is a system defining the semantics of the protocol.

  First, we need to define a transformation of systems to use
  a \emph{router} $\mathcal{R}$, which will be a special system
  allowing an adversary to control the order of delivery of messages.

  Let $\{A_1, \ldots, A_n\} = \tx{Chan}(P_1, \ldots, P_n)$.
  We then define $\mathcal{R}$ as the syten:
\package{$\mathcal{R}$}{
&\underline{\tx{Deliver}_{A_i}()\tx{:}}\cr
\pind{1} \precv{m}{\langle A_i, \mathcal{R} \rangle}\cr
\pind{1} \psend{m}{\langle \mathcal{R}, A_i \rangle}\cr
}

  Next, we define a transformation $\tx{Routed}(S)$ of a system,
  which makes communication pass via the router:
  \begin{itemize}
    \item Whenever $S$ sends $m$ via $A$, $\tx{Routed}(S)$ sends $m$ via $\langle A , \mathcal{R} \rangle$.
    \item Whenever $S$ receives $m$ via $B$, $\tx{Routed}(S)$ recieves $m$ via $\langle \mathcal{R}, B \rangle$.
  \end{itemize}

With this in hand, we define:
$$
\tx{Inst}_C(\mathcal{P}) :=
  \begin{pmatrix}
    {\displaystyle \bigast}_{i \in [n]} \tx{Routed}(\tx{Corrupt}_C(P_i))\cr
    *\cr
    \mathcal{R}\cr
    \otimes\cr
    1(\tx{Leakage})
  \end{pmatrix}
  \circ F
$$


$\square$
\end{definition}

\begin{lemma}[Properties of $\tx{Routed}$]
  \label{thm:routed}
  For any systems $A, B$, we have:
$$
\begin{aligned}
  &\tx{Routed}(A \circ B) = \tx{Routed}(A) \circ \tx{Routed}(B)\cr
  &\tx{Routed}(A * B) = \tx{Routed}(A) * \tx{Routed}(B)\cr
  &\tx{Routed}(A \otimes B) = \tx{Routed}(A) \otimes \tx{Routed}(B)\cr
\end{aligned}
$$
(provided these expressions are well defined)

\txbf{Proof:} The $\tx{Routed}$ transformation simply
renames each sending and receiving channel in a system.
In all the cases above, even $A * B$, all of the channels present
in $A$ and $B$ are present in the composition, and so all
of these equations hold.

$\blacksquare$
\end{lemma}


\begin{definition}[Compatible Corruptions]
  \label{def:compatc}
  Given protocols $\mathcal{P}, \mathcal{Q}$, and a corruption model
  $C$ for $\mathcal{Q}$, we can define a notion of a \emph{compatible}
  corruption model $C'$ for $\mathcal{P} \otimes \mathcal{Q}$ or $\mathcal{P} \circ \mathcal{Q}$,
  provided these expressions are well defined.

  A corruption model $C'$ for $\mathcal{P} \otimes \mathcal{Q}$.
  is compatible with $C$ when every corruption of a player
  in $\mathcal{Q}$ is $\geq$ that of the corresponding corruption in $C$.

  We say that a corruption model $C'$ for $\mathcal{P} \circ \mathcal{Q}$ is compatible with
a corruption model $C$ for $\mathcal{Q}$ if for every
$\mathcal{Q}.P_j$ used by $\mathcal{P}.P_i$, the corruption
level of $\mathcal{Q}.P_j$ in $\mathcal{C}'$ is $\geq$ the corruption level of $\mathcal{P}.P_i$
in $\mathcal{C}$.

  Furthermore, we say that $C'$ is \emph{strictly} compatible
  with $C$ if the above property holds with $=$, and not just $\geq$.

  This extends to corruption \emph{classes} as well.
  A corruption class $\mathcal{C}'$ is (strictly) compatible with a class $\mathcal{C}$,
  if every $C' \in \mathcal{C}'$ is (strictly) compatible with some $C \in \mathcal{C}$.

  $\square$
\end{definition}

\begin{theorem}[Concurrent Breakdown]
  \label{thm:concurrent_breakdown}
  Given protocols $\mathcal{P}, \mathcal{Q}$, and a corruption model $C$
  for $\mathcal{Q}$, then for any corruption model $C'$ for $\mathcal{P} \otimes \mathcal{Q}$ compatible with $C$, we have:
  \[
    \tx{Inst}_{C'}(\mathcal{P} \otimes \mathcal{Q}) = \tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_C(\mathcal{Q})
  \]
\txbf{Proof:} If we unroll $\text{Inst}_{C'}(\mathcal{P} \otimes \mathcal{Q})$, we get:
$$
\begin{pmatrix}
\mathcal{R}\cr
*\cr
\left(\bigast_{i \in [\mathcal{P}.n]} \tx{Routed}(\tx{Corrupt}_{C'}(\mathcal{P}.P_i))\right)\cr
*\cr
\left(\bigast_{i \in [\mathcal{Q}.n]} \tx{Routed}(\tx{Corrupt}_{C'}(\mathcal{Q}.P_i))\right)\cr
\otimes\cr
1(\mathcal{P}.\tx{Leakage}, \mathcal{Q}.\tx{Leakage})
\end{pmatrix}
\circ
\begin{pmatrix}
\mathcal{P}.F\cr
\otimes\cr
\mathcal{Q}.F\cr
\end{pmatrix}
$$

We can apply a few observations here:
\begin{enumerate}
  \item Since $\mathcal{C}'$ is compatible with $\mathcal{C}$, then $\mathcal{Q}.P_i$ follows a corruption from $\mathcal{C}$.
  \item $\mathcal{R}$ can be written as $\mathcal{R}_\mathcal{P} \otimes \mathcal{R}_\mathcal{Q}$,
  with one system using channels in $\mathcal{P}$, and the other using channels in $\mathcal{Q}$.
  \item Since protocols are closed, we can use $\otimes$ between the players in $\mathcal{P}$ and $\mathcal{Q}$,
  since they never send messages to each other.
\end{enumerate}
This results in the following:
$$
\begin{pmatrix}
  \mathcal{R}_{\mathcal{P}} * \left(\bigast_{i \in [\mathcal{P}.n]} \tx{Routed}(\tx{Corrupt}_{C'}(\mathcal{P}.P_i))\right) \otimes 1(\mathcal{P}.\tx{Leakage})\cr
\otimes\cr
  \mathcal{R}_{\mathcal{Q}} * \left(\bigast_{i \in [\mathcal{Q}.n]} \tx{Routed}(\tx{Corrupt}_{C}(\mathcal{Q}.P_i))\right) \otimes 1(\mathcal{Q}.\tx{Leakage})
\end{pmatrix}
\circ
\begin{pmatrix}
\mathcal{P}.F\cr
\otimes\cr
\mathcal{Q}.F\cr
\end{pmatrix}
$$
From here, we apply Lemma~\ref{thm:interchange_system} (interchange), to get:
$$
\begin{matrix}
\tx{Inst}_{C'}(\mathcal{P})\cr
\otimes\cr
\tx{Inst}_{C}(\mathcal{Q})\cr
\end{matrix}
$$

$\blacksquare$

\end{theorem}

\begin{theorem}[Horizontal Breakdown]
  \label{thm:horizontal_breakdown}
  Given protocols $\mathcal{P}, \mathcal{Q}$, and a corruption
  model $C$ for $\mathcal{Q}$, then for any compatible corruption
  model $C'$ for $\mathcal{P} \lhd \mathcal{Q}$, there exists
  systems $S_1, \ldots, S_{\mathcal{Q}.n}$ and a set $L_{\mathcal{Q}}$ such that:
  $$
  \tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}) =
  1(O)\circ
  \begin{pmatrix}
    {\displaystyle \bigast}_{i \in [\mathcal{P}.n]} \tx{Routed}(\tx{Corrupt}'_{C'}(\mathcal{P}.P_i))
    \cr
    *\cr
    \mathcal{R}_{\mathcal{P}}\cr
    \otimes\cr
    1(\tx{Leakage}, L_{\mathcal{Q}})
  \end{pmatrix}
  \circ
  \begin{pmatrix}
    \mathcal{P}.F\cr
    \otimes\cr
    1(\tx{Out}(\mathcal{R}_q))\cr
    \otimes\cr
    1(\mathcal{Q}.\tx{Leakage})\cr
    \otimes\cr
    \bigotimes_{i \in [\mathcal{Q}.n]} S_i\cr
  \end{pmatrix}
  \circ
  \begin{pmatrix}
  \tx{Inst}_C(\mathcal{Q})\cr
  \otimes\cr
  1(\tx{In}(\mathcal{P}.F))
  \end{pmatrix}
  $$
  where $O := \tx{Out}(\tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}))$,
  $\mathcal{R}_{\mathcal{P}} \circ \mathcal{R}_{\mathcal{Q}} = \mathcal{R}$
  are a decomposition of the router $\mathcal{R}$ for $\mathcal{P} \lhd \mathcal{Q}$,
  and $\tx{Corrupt}'_{C'}(\ldots)$ is the same as $\tx{Corrupt}_{C'}$,
  except that malicious corruption contains no $\tx{Call}_{F_i}$ functions,
  for $F_i \notin \tx{Out}(\mathcal{P}.F)$

  Furthermore, if the models are \emph{strictly} compatible,
  then $S_j = 1(\tx{Out}(\tx{Routed}(\tx{Corrupt}_C(\mathcal{Q}.P_i))))$.

\txbf{Proof:} We start by unrolling $\tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q})$,
to get:
\[
\tx{Inst}_C(\mathcal{P} \lhd \mathcal{Q}) =
  \begin{pmatrix}
    {\displaystyle \bigast}_{i \in [\mathcal{P}.n]} \tx{Routed}\left(\tx{Corrupt}_{C'}\left(\mathcal{P}.P_i \circ 
        
    \begin{pmatrix}
    \bigast_{\mathcal{Q}.P_j \tx{ used by } \mathcal{P}.P_i} \mathcal{Q}.P_j\cr
    \otimes\cr
    1(\tx{IdealIn}_i)
    \end{pmatrix}
    \right)\right)\cr
    *\cr
    \mathcal{R}\cr
    \otimes\cr
    1(\tx{Leakage})
  \end{pmatrix}
  \circ \begin{pmatrix}
    \mathcal{P}.F\cr
    \otimes \cr
    \mathcal{Q}.F
  \end{pmatrix}
\]
Our strategy will be to progressively build up an equivalent system
to this one, starting with $\tx{Corrupt}_C$, then $\tx{Routed}$, etc.

First, some observations about $\tx{Corrupt}_\kappa(P \circ (1(I) \otimes Q_1 * \cdots * Q_m))$,
where ${I \cap \tx{In}(Q_1, \ldots) = \emptyset}$.

In the case of malicious corruption, we have:
$$
\tx{Corrupt}_M(P \circ (1(I) \otimes Q_1 * \cdots)) =
1(O) \circ
\begin{pmatrix}
  \tx{Corrupt}'_M(P)\cr
  \otimes\cr
  1(\tx{Out}(\tx{Corrupt}_M(Q_1)), \ldots)\cr
\end{pmatrix}
\circ
\begin{pmatrix}
  1(I)\cr
  \otimes\cr
  \tx{Corrupt}_M(Q_1)\cr
  *\cr
  \cdots\cr
\end{pmatrix}
$$
for $O = \tx{Out}(\tx{Corrupt}_M(P \circ (Q_1 * \cdots)))$.
This holds by definition, since corruption $P \circ (Q_1 * \cdots)$ precisely allows
sending messages on behalf of $P$ or any $Q_i$, as well as calling
the input functions to the $Q_i$ systems.
Since we can't call the functions that $P$ uses,
we use $\tx{Corrupt}'_{M}$, which modifies malicious corruption to only
contain $\tx{Send}_{A_i}$, $\tx{Test}_{B_i}$, $\tx{Recv}_{B_i}$,
and $\tx{Call}_{F_i}$ for $F_i \in I$.
In particular the $\tx{Call}_{\bullet}$ functions are omitted for the functions
provided by $Q_1, \ldots, Q_m$.
We can write this expression more concisely,
using $1(L^M)$ for $L^M = \tx{Out}(\tx{Corrupt}_M(Q_1)) \cup \cdots$.

Next, we look at semi-honest corruption.
Because the logs are divided into independent sub logs, we can write:
$$
\tx{Corrupt}_{\tx{SH}}(P \circ (1(I) \otimes Q_1 * \cdots)) =
1(O) \circ
\begin{pmatrix}
  \tx{Corrupt}_{\tx{SH}}(P)\cr
  \otimes\cr
  1(\{Q_1.\tx{log}, \ldots\})
\end{pmatrix}
\circ
\begin{pmatrix}
  1(I)\cr
  \otimes\cr
  \tx{Corrupt}_{\tx{SH}}(Q_1)\cr
  *\cr
  \cdots
\end{pmatrix}
$$
where $O = \tx{Out}(\tx{Corrupt}_{\tx{SH}}(P \circ (Q_1 * \cdots)))$

And for honest corruption, we have
$$
\tx{Corrupt}_{\tx{H}}(P \circ (1(I) \otimes Q_1 * \cdots)) = P \circ (1(I) \otimes Q_1 * \cdots)
$$

Now, the compatibility condition of $C'$ relative to $C$
does not guarantee that if $\mathcal{P}.P_i$ uses $\mathcal{Q}.P_j$,
then $\mathcal{Q}.P_j$ has the same level of corruption: 
it only guarantees a level of corruption at least as strong.
By Lemma~\ref{thm:simulatingcorruption}, we can simulate a weaker
form of corruption using a stronger form, via some simulator system $S$,
depending on the levels of corruption.

Using these simulators, we get, slightly different results based
on the level of corruption.

When $C'_i = \tx{M}$:
$$
\tx{Corrupt}_{C'}((\mathcal{P} \lhd \mathcal{Q}).P_i) =
1(O_i) \circ
\begin{pmatrix}
  \tx{Corrupt}'_{C'}(\mathcal{P}.P_i)\cr
  \otimes\cr
  1(L_i)\cr
\end{pmatrix}
\circ
\begin{pmatrix}
\displaystyle \bigast_{\mathcal{Q}.P_j \tx{ used by } \mathcal{P}.P_i}
  \tx{Corrupt}_C(\mathcal{Q}.P_j)\cr
\otimes\cr
1(\tx{IdealIn}_i)
\end{pmatrix}
$$
with $O_i = \tx{Out}(\tx{Corrupt}_{C'}(\mathcal{P} \lhd \mathcal{Q}).P_i)$, $L_i= \bigcup_{\mathcal{Q}.P_j \tx{ used by } \mathcal{P}.P_i} \tx{Out}(\tx{Corrupt}_M(\mathcal{Q}.P_j))$.
No simulation is needed, since the compatibility of $C'$ with $C$
guarantees that all of the players used by $\mathcal{P}.P_i$
are maliciously corrupted.

When $C'_i = \tx{SH}$:
$$
\tx{Corrupt}_{C'}((\mathcal{P} \lhd \mathcal{Q}).P_i) =
1(O_i) \circ
\begin{pmatrix}
  \tx{Corrupt}_{\tx{C'}}(P)\cr
  \otimes\cr
  1(L_i)
\end{pmatrix}
\circ
\begin{pmatrix}
\displaystyle \bigast_{\mathcal{Q}.P_j \tx{ used by } \mathcal{P}.P_i}
  S_j \circ \tx{Corrupt}_C(\mathcal{Q}.P_j)\cr
  \otimes\cr
1(\tx{IdealIn}_i)
\end{pmatrix}
$$
with $O_i = \tx{Out}(\tx{Corrupt}_{C'}(\mathcal{P} \lhd \mathcal{Q}).P_i)$,
$L_i = \{\mathcal{Q}.P_j.\tx{log} \mid \mathcal{Q}.P_j \tx{ used by } \mathcal{P}.P_i \}$,
and $S_j$ depending on the level of corruption for $\mathcal{Q}.P_j$ in $C$:
\begin{itemize}
  \item $S_j = S_{\tx{SH}}$ if $C_j = \tx{M}$
  \item $S_j = 1$ if $C_j = \tx{SH}$
\end{itemize}

When $C'_i = \tx{H}$:
$$
\tx{Corrupt}_{C'}((\mathcal{P} \lhd \mathcal{Q}).P_i) =
  \tx{Corrupt}_{\tx{C'}}(P)
\circ
\begin{pmatrix}
\displaystyle \bigast_{\mathcal{Q}.P_j \tx{ used by } \mathcal{P}.P_i}
  S_j \circ \tx{Corrupt}_C(\mathcal{Q}.P_j)\cr
\otimes\cr
1(\tx{IdealIn}_i)
\end{pmatrix}
$$
with $S_j$ depending on the level of corruption for $\mathcal{Q}.P_j$ in $C$:
\begin{itemize}
  \item $S_j = S_{\tx{H}} \circ S_{\tx{SH}}$ if $C_j = \tx{M}$
  \item $S_j = S_{\tx{H}}$ if $C_j = \tx{SH}$
  \item $S_j = 1$ if $C_j = \tx{H}$
\end{itemize}

We can unify these three cases, writing:
$$
\tx{Corrupt}'_{C'}((\mathcal{P} \lhd \mathcal{Q}).P_i) =
1(O_i) \circ
\begin{pmatrix}
  \tx{Corrupt}_{\tx{C'}}(P)\cr
  \otimes\cr
  1(L_i)
\end{pmatrix}
\circ
\begin{pmatrix}
\bigast_{\mathcal{Q}.P_j \tx{ used by } \mathcal{P}.P_i}
  S_j \circ \tx{Corrupt}_C(\mathcal{Q}.P_j)\cr
  \otimes\cr
1(\tx{IdealIn}_i)
\end{pmatrix}
$$
with $O_i$ and $L_i$ depending on the corruption level of $\mathcal{P}.P_i$,
and $S_j$ depending on the corruption levels of both $\mathcal{P}.P_i$
and $\mathcal{Q}.P_j$.

By the properties of $\tx{Routed}$ (Lemma~\ref{thm:routed}), we have:
$$
\begin{aligned}
&\tx{Routed}(\tx{Corrupt}'_{C'}((\mathcal{P} \lhd \mathcal{Q}).P_i)) =\cr
&1(O_i) \circ
\begin{pmatrix}
  \tx{Routed}(\tx{Corrupt}'_{\tx{C'}}(P))\cr
  \otimes\cr
  1(L_i)
\end{pmatrix}
\circ
\begin{pmatrix}
\displaystyle\bigast_{\mathcal{Q}.P_j \tx{ used by } \mathcal{P}.P_i}
  S_j \circ \tx{Routed}(\tx{Corrupt}_C(\mathcal{Q}.P_j))\cr
  \otimes\cr
1(\tx{IdealIn}_i)
\end{pmatrix}
\end{aligned}
$$

Next, we need to add the router $\mathcal{R}$.
We note that since $\mathcal{P}$ and $\mathcal{Q}$ have separate channels,
we can write $\mathcal{R} = \mathcal{R}_{\mathcal{P}} \circ \mathcal{R}_{\mathcal{Q}}$,
where the latter contains only the channels in $\mathcal{Q}$,
and the former contains the channels in $\mathcal{P}$,
and provides access to those in $\mathcal{Q}$ via its function dependencies.
Combing this with the interchange lemma, we get:
$$
\begin{aligned}
&\mathcal{R} * \bigast_{i \in [\mathcal{P}.n]}\tx{Routed}(\tx{Corrupt}'_{C'}((\mathcal{P} \lhd \mathcal{Q}).P_i)) * \mathcal{R} =\cr
&1(\tx{Out}(\mathcal{R}), O_1, \ldots, O_{\mathcal{P}.n}) \circ
\begin{pmatrix}
  \tx{Routed}(\tx{Corrupt}_{\tx{C'}}(P))\cr
  *\cr
  \mathcal{R}_{\mathcal{P}}\cr
  \otimes\cr
  1(L_1, \ldots, L_{\mathcal{P}.n})
\end{pmatrix}
\circ
\begin{pmatrix}
\bigast_{j \in [\mathcal{Q}.n]}
  S_j \circ \tx{Routed}(\tx{Corrupt}_C(\mathcal{Q}.P_j))
  \cr
  *\cr
  \mathcal{R}_{\mathcal{Q}}\cr
  \otimes\cr
  1(\tx{Out}(F))
\end{pmatrix}
\end{aligned}
$$

All that remains is to add the ideal functionalities, giving us,
after application of the interchange lemma:
$$
\begin{aligned}
  &\tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}) =\cr
&1(O) \circ
\begin{pmatrix}
  \tx{Routed}(\tx{Corrupt}'_{\tx{C'}}(P))\cr
  *\cr
  \mathcal{R}_{\mathcal{P}}\cr
  \otimes\cr
  1(\tx{Leakage}, L_{\mathcal{Q}})
\end{pmatrix}
\circ
\begin{pmatrix}
\bigast_{j \in [\mathcal{Q}.n]}
  S_j \circ \tx{Routed}(\tx{Corrupt}_C(\mathcal{Q}.P_j))
  \cr
  *\cr
  \mathcal{R}_{\mathcal{Q}}\cr
  \otimes\cr
  1(\tx{Leakage}, \tx{Out}(F))
\end{pmatrix}
\circ
\begin{pmatrix}
  \mathcal{P}.F\cr
  \otimes\cr
  \mathcal{Q}.F
\end{pmatrix}
\end{aligned}
$$
with $O := \tx{Out}(\tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}))$,
and $L_{\mathcal{Q}} := \bigcup_{i \in [\mathcal{P}.n]} L_i$.

Now, because $\mathcal{Q}$ does not use any of the functions
in $\mathcal{P}.F$, and because each simulator $S_j$
does not use any channels, we can rewrite this as:
$$
\small
1(O) \circ
\begin{pmatrix}
  \tx{Routed}(\tx{Corrupt}'_{\tx{C'}}(P))\cr
  *\cr
  \mathcal{R}_{\mathcal{P}}\cr
  \otimes\cr
  1(\tx{Leakage}, L_{\mathcal{Q}})
\end{pmatrix}
\circ
\begin{pmatrix}
  \mathcal{P}.F\cr
  \otimes\cr
  1(\tx{Out}(\mathcal{R}_{\mathcal{Q}}))\cr
  \otimes\cr
  1(\mathcal{Q}.\tx{Leakage})\cr
  \otimes\cr
  \bigotimes_{j \in [\mathcal{Q}.n]} S_j
\end{pmatrix}
\circ
\begin{pmatrix}
\begin{pmatrix}
\bigast_{j \in [\mathcal{Q}.n]}
  \tx{Routed}(\tx{Corrupt}_C(\mathcal{Q}.P_j))
  \cr
  *\cr
  \mathcal{R}_{\mathcal{Q}}\cr
  \otimes\cr
  1(\mathcal{Q}.\tx{Leakage})
\end{pmatrix}
\circ
  \mathcal{Q}.F
  \cr
  \otimes\cr
  1(\tx{In}(\mathcal{P}.F))
\end{pmatrix}
$$

We can then notice that the right hand side of this equation
is simply $\tx{Inst}_C(\mathcal{Q})$,
concluding our proof.

$\blacksquare$

\end{theorem}

\subsection{Equality and Simulation}

\begin{definition}[Shape]
  \label{def:shape}
  We say that two protocols $\mathcal{P}, \mathcal{Q}$ have the same \emph{shape}
  if there exists a protocol $\mathcal{Q}' \equiv \mathcal{Q}$ such that:
  \begin{itemize}
    \item $\mathcal{P}.n = \mathcal{Q}'.n$,
    \item $\forall i \in [n].\quad \tx{In}(\mathcal{P}.P_i) = \tx{In}(\mathcal{Q}'.Q_i)$,
    \item $\forall i \in [n].\quad \tx{Out}(\mathcal{P}.P_i) = \tx{Out}(\mathcal{Q}'.Q_i)$,
    \item $\tx{Leakage}(\mathcal{P}) = \tx{Leakage}(\mathcal{Q}')$,
    \item $\tx{IdealIn}(\mathcal{P}) = \tx{IdealIn}(\mathcal{Q}')$.
  \end{itemize}

  $\square$
\end{definition}

\begin{definition}[Semantic Equality]
  We say that two closed protocols $\mathcal{P}$ and $\mathcal{Q}$,
  with the same shape,
  are equal under a class of corruptions $\mathcal{C}$,
  written as $\mathcal{P} =_{\mathcal{C}} \mathcal{Q}$, when we have:
  $$
  \forall C \in \mathcal{C}.\quad \tx{Inst}_C(\mathcal{P}) = \tx{Inst}_C(\mathcal{Q'})
  $$
  as systems, with $\mathcal{Q}' \equiv \mathcal{Q}$ as per 
  Definition~\ref{def:shape}.

  $\square$

\end{definition}

\begin{definition}[Indistinguishability]
  We say that two closed protocols $\mathcal{P}$ and $\mathcal{Q}$,
  with the same shape,
  are \emph{indistinguishable} up to $\epsilon$ under a class of corruptions $\mathcal{C}$,
  written as $\mathcal{P} \overset{\epsilon}{\approx}_{\mathcal{C}} \mathcal{Q}$, when we have:
  $$
  \forall C \in \mathcal{C}.\quad \tx{Inst}_C(\mathcal{P}) \overset{\epsilon}{\approx} \tx{Inst}_C(\mathcal{Q'})
  $$
  as systems, with $\mathcal{Q}' \equiv \mathcal{Q}$ as per 
  Definition~\ref{def:shape}.

  $\square$

\end{definition}

\begin{definition}[Simulated Instantiation]
  A simulator $S$ for a closed protocol $\mathcal{P}$ under a corruption
  model $C$ is a system satisfying:
  \begin{itemize}
    \item $\tx{InChan}(S), \tx{OutChan}(S) = \emptyset$,
    \item $\tx{In}(S) = \tx{Leakage} \cup \left(\bigcup_{C_i = \tx{M}} \tx{Out}(\tx{Corrupt}_{\tx{M}}(P_i))\right) \cup \left(\bigcup_{C_i = \tx{SH}} P_i.\tx{log}\right)$,
    \item $\tx{Out}(S) = \tx{In}(S)$,
  \end{itemize}

  Given such a simulator, we can define the simulated instantiation
  of $\mathcal{P}$ under $C$ with $S$ as:
  $$
  \tx{SimInst}_{S, C}(\mathcal{P}) := 
  \begin{pmatrix}
    S\cr
    \otimes\cr
    1(\tx{Out}(\tx{Inst}_C(\mathcal{P})) / \tx{Out}(S))
  \end{pmatrix}
  \circ \tx{Inst}_C(\mathcal{P})
  $$

  $\square$
\end{definition}

\begin{definition}[Simulatability]
  Given closed protocols $\mathcal{P}, \mathcal{Q}$ with the same shape,
  we say that $\mathcal{P}$ is \emph{simulatable} up to $\epsilon$ by $\mathcal{Q}$
  under a class of corruptions $\mathcal{C}$,
  written as $\mathcal{P} \overset{\epsilon}{\leadsto}_{\mathcal{C}} \mathcal{Q}$,
  when:
  $$
  \forall C \in \mathcal{C}.\exists S.\quad \tx{Inst}_C(\mathcal{P}) \overset{\epsilon}{\approx} \tx{SimInst}_{S, C}(\mathcal{Q}')
  $$
  as systems, with $\mathcal{Q}' \equiv \mathcal{Q}$ as per 
  Definition~\ref{def:shape}.

  $\square$
\end{definition}

\begin{theorem}[Equality Hierarchy]
  \label{thm:equality_hierarchy}
For any corruption class $\mathcal{C}$, we have:
\begin{enumerate}
\item $\mathcal{P} \equiv \mathcal{Q} \implies \mathcal{P} =_\mathcal{C} \mathcal{Q}$.
\item $\mathcal{P} =_{\mathcal{C}} \mathcal{Q} \implies \mathcal{P} \overset{0}{\approx}_\mathcal{C} \mathcal{Q}$.
\item $\mathcal{P} \overset{\epsilon}{\approx}_{\mathcal{C}} \mathcal{Q} \implies \mathcal{P} \overset{\epsilon}{\leadsto}_\mathcal{C} \mathcal{Q}$.
\end{enumerate}

\txbf{Proof:}

\txbf{1.} 
For any $C \in \mathcal{C}$, $\tx{Corrupt}_{C}$ and $\tx{Routed}$ are equality respecting,
so we have:
$$
\forall i \in [n].\quad \tx{Routed}(\tx{Corrupt}_C(\mathcal{P}.P_i)) = 
\tx{Routed}(\tx{Corrupt}_C(\mathcal{Q}.P_i))
$$

Furthermore, the equality of players between $\mathcal{P}$ and $\mathcal{Q}$
makes $\mathcal{P}.\mathcal{R} = \mathcal{Q}.\mathcal{R}$.

And then, the fact that $\mathcal{P}.F = \mathcal{Q}.F$ forces $\tx{Leakage}$
to be the same as well.

Finally, since $\circ, *, \otimes$ are respect $\equiv$, we
can clearly see that $\tx{Inst}_C(\mathcal{P}) = \tx{Inst}_C(\mathcal{Q})$,
since all the sub-components are literally equal.

\txbf{2.} For any systems $A, B$, we have $A = B \implies A \overset{0}{\approx} B$.
Applying this to $\tx{Inst}_C(\mathcal{P})$ and $\tx{Inst}_C(\mathcal{Q})$
gives us our result.

\txbf{3.} It suffices to define a simulator $S$ such that
$\tx{SimInst}_{S, C}(\mathcal{Q}) = \tx{Inst}_C(\mathcal{Q})$,
which will then show our result.
We can simply take $S = 1(\ldots)$ for the right set.

$\blacksquare$
\end{theorem}

\begin{theorem}[Transitivity of Equality]
  \label{thm:prot_trans}
  For any closed protocols $\mathcal{L}, \mathcal{P}, \mathcal{Q}$ with the same shape,
  and any class of corruptions $\mathcal{C}$, we have:
  \begin{enumerate}
    \item $\mathcal{L} =_{\mathcal{C}} \mathcal{P}, \mathcal{P} =_{\mathcal{C}} \mathcal{Q} \implies \mathcal{L} =_{\mathcal{C}}\mathcal{Q}$,
    \item $\mathcal{L} \overset{\epsilon_1}{\approx}_{\mathcal{C}} \mathcal{P}, \mathcal{P} \overset{\epsilon_2}{\approx}_{\mathcal{C}} \mathcal{Q} \implies \mathcal{L} \overset{\epsilon_1 + \epsilon_2}{\approx}_{\mathcal{C}} \mathcal{Q}$,
    \item $\mathcal{L} \overset{\epsilon_1}{\leadsto}_{\mathcal{C}} \mathcal{P}, \mathcal{P} \overset{\epsilon_2}{\leadsto}_{\mathcal{C}} \mathcal{Q} \implies \mathcal{L} \overset{\epsilon_1 + \epsilon_2}{\leadsto}_{\mathcal{C}} \mathcal{Q}$.
  \end{enumerate}

  \txbf{Proof:} The first two parts follow directly from Lemma~\ref{thm:system_trans} (
    transitivity for system equality
  ).
  Indeed, we just look at $\tx{Inst}_C(\mathcal{L})$, $\tx{Inst}_C(\mathcal{P})$, and $\tx{Inst}_C(\mathcal{Q})$
  as systems, for any corruption model $C$.

  For part 3, by assumption we have, for any $C \in \mathcal{C}$:
  \begin{itemize}
  \item $\tx{Inst}_C(\mathcal{L}) \overset{\epsilon_1}{\approx} \begin{pmatrix} S_1\cr \otimes\cr 1(O)\end{pmatrix} \tx{Inst}_C(\mathcal{P})$,
  \item $\tx{Inst}_C(\mathcal{P}) \overset{\epsilon_1}{\approx} \begin{pmatrix} S_2\cr \otimes\cr 1(O)\end{pmatrix} \tx{Inst}_C(\mathcal{Q})$.
  \end{itemize}
  This means that:
  $$
  \tx{Inst}_C(\mathcal{L}) \overset{\epsilon_1 + \epsilon_2}{\approx}
  \begin{pmatrix}
    S_1 \cr
    \otimes\cr
    1(O)
  \end{pmatrix}
  \circ
  \begin{pmatrix}
    S_2 \cr
    \otimes\cr
    1(O)
  \end{pmatrix}
  \circ
  \tx{Inst}_C(\mathcal{Q})
  $$
  applying the properties we have for systems.

  Then, we can apply interchange to write this as:
  $$
  \begin{pmatrix}
    S_1 \circ S_2 \cr
    \otimes\cr
    1(O)
  \end{pmatrix}
  \circ
  \tx{Inst}_C(\mathcal{Q})
  $$
  which concludes our proof, since $S_1 \circ S_2$ will be a valid simulator.

  $\blacksquare$
\end{theorem}

\begin{theorem}[Malicious Completeness]
  \label{thm:mal_complete}
  Let $\mathcal{P}$ and $\mathcal{Q}$ closed protocols with the same shape.
  Given any class of corruptions $\mathcal{C}$, let $\mathcal{C}'$ be a related class, containing
  models in $\mathcal{C}$ with some
  malicious corruptions replaced with semi-honest corruptions.
  We then have:
  \begin{enumerate}
    \item $\mathcal{P} =_{C} \mathcal{Q} \implies \mathcal{P} =_{C'} \mathcal{Q}$,
    \item $\mathcal{P} \overset{\epsilon}{\approx}_{C} \mathcal{Q} \implies \mathcal{P} \overset{\epsilon}{\approx}_{C'} \mathcal{Q}$,
  \end{enumerate}

  \txbf{Proof:} Lemma~\label{thm:simulatingcorruption} (simulating corruptions) is the crux of our proof.
  It implies that there existts a system $S_{\tx{SH}}$ such that
  $$
  \tx{Corrupt}_{\tx{SH}}(P) = S_{\tx{SH}} \circ \tx{Corrupt}_M(P)
  $$

  As a consequence, for any $C' \in \mathcal{C}'$ and the $C \in \mathcal{C}$ it's related to,
  there exists a \emph{simulator} $S_{\tx{SH}}$ such that:
  $$
  \tx{Inst}_{C'}(\mathcal{P}) =
  \begin{pmatrix}
    S_{\tx{SH}}\cr
    \otimes\cr
    1(O)
  \end{pmatrix}
  \circ \tx{Inst}_{C}(\mathcal{P})
  $$
  which simulates all of the semi-honest corruptions in $C'$ from the malicious ones in $C$.

  This immediately implies parts 1 and 2, by the fact that $\circ$ for systems
  respects equality and indistinguishability.

  $\blacksquare$
\end{theorem}

\begin{theorem}[Vertical Composition Theorem]
  \label{thm:vertical_composition_theorem}
  For any protocol $\mathcal{P}$ and game $G$, such that $\mathcal{P} \circ G$
  is well defined and closed, and for any corruption class $\mathcal{C}$, we have:
  \begin{enumerate}
    \item $G = G' \implies \mathcal{P} \circ G =_{\mathcal{C}} \mathcal{P} \circ G'$
    \item $G \overset{\epsilon}{\approx} G' \implies \mathcal{P} \circ G \overset{\epsilon}{\approx}_{\mathcal{C}} \mathcal{P} \circ G'$
  \end{enumerate}
  
\txbf{Proof:} We start by noting that $\tx{Inst}_C(\mathcal{P} \circ G) = A \circ F \circ G$,
for some system $A$.
Part 1 follows immediately from this, since $\circ$ is equality respecting.

Part 2 follows by applying Lemma~\ref{thm:systemreduction},
which entails that for any system $S$, we have $S \circ G \overset{\epsilon}{\approx} S \circ G'$.

$\blacksquare$
\end{theorem}

\begin{theorem}[Concurrent Composition Theorem]
  Let $\mathcal{P}, \mathcal{Q}$ be protocols, with $\mathcal{P} \otimes \mathcal{Q}$
  well defined and closed. For any compatible corruption classes $\mathcal{C}, \mathcal{C}'$
  it holds that:
  \begin{enumerate}
    \item $\mathcal{Q} =_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \otimes \mathcal{Q} =_{\mathcal{C}'} \mathcal{P} \otimes \mathcal{Q}'$
    \item $\mathcal{Q} \overset{\epsilon}{\approx}_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \otimes \mathcal{Q} \overset{\epsilon}{\approx}_{\mathcal{C}'} \mathcal{P} \otimes \mathcal{Q}'$
    \item $\mathcal{Q} \overset{\epsilon}{\leadsto}_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \otimes \mathcal{Q} \overset{\epsilon}{\leadsto}_{\mathcal{C}'} \mathcal{P} \otimes \mathcal{Q}'$
  \end{enumerate}

  \txbf{Proof:} Theorem~\ref{thm:concurrent_breakdown} (concurrent breakdown)
  will be essential to our proof.
  This implies that $\forall C \in \mathcal{C}$, then for any compatible $C' \in \mathcal{C}'$
  we have:
  $$
  \tx{Inst}_{C'}(\mathcal{P} \otimes \mathcal{Q}) = \tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_{C}(\mathcal{Q})
  $$

\txbf{1.}
Since $\mathcal{Q} =_{\mathcal{C}} \mathcal{Q}'$, we have $\forall C \in \mathcal{C}.\ \tx{Inst}_C(\mathcal{Q}) = \tx{Inst}_C(\mathcal{Q}')$.
Now, consider any $C' \in \mathcal{C}'$.
By our assumption that $\mathcal{C}'$ is compatible with $\mathcal{C}$,
there exists a $C \in \mathcal{C}$ that $C'$ is compatible with.
Using concurrent breakdown, we then have:
$$
\tx{Inst}_{C'}(\mathcal{P} \otimes \mathcal{Q}) =
\tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_C(\mathcal{Q})
$$
Then, since $\mathcal{Q} =_{\mathcal{C}} \mathcal{Q}'$, we have:
$$
\tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_C(\mathcal{Q}) =
\tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_C(\mathcal{Q}') =
\tx{Inst}_{C'}(\mathcal{P} \otimes \mathcal{Q}')
$$
concluding our proof.

\txbf{2.}
The proof here is similar to part 1.
For any $C' \in \mathcal{C}'$, there exists a compatible $C \in \mathcal{C}$,
and then we get:
$$
\tx{Inst}_{C'}(\mathcal{P} \otimes \mathcal{Q}) =
\tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_C(\mathcal{Q})
$$
Since $\mathcal{Q} \overset{\epsilon}{\approx}_{\mathcal{C}} \mathcal{Q}'$,
we have:
$$
\tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_C(\mathcal{Q})
\overset{\epsilon}{\approx} 
\tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_C(\mathcal{Q}')
$$
since $\otimes$ for systems respects this operation.
We can then conclude with
$$
\tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_C(\mathcal{Q}') =
\tx{Inst}_{C'}(\mathcal{P} \otimes \mathcal{Q}')
$$

\txbf{3.} Once more, for any $C' \in \mathcal{C}'$, there exists a compatible
$C \in \mathcal{C}$ giving us:
$$
\tx{Inst}_{C'}(\mathcal{P} \otimes \mathcal{Q}) =
\tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_C(\mathcal{Q})
$$
We then apply our assumption that $\mathcal{Q} \overset{\epsilon}{\leadsto}_{\mathcal{C}} \mathcal{Q}'$
to get:
$$
\tx{Inst}_{C'}(\mathcal{P}) \otimes \tx{Inst}_C(\mathcal{Q})
\overset{\epsilon}{\approx}
\tx{Inst}_{C'}(\mathcal{P}) \otimes ((S \otimes 1(\ldots)) \circ \tx{Inst}_C(\mathcal{Q}'))
$$
Next, we apply interchange to get:
$$
\begin{matrix}
1(\tx{Out}(\tx{Inst}_{C'}(\mathcal{P}))) \circ \tx{Inst}_{C'}(\mathcal{P})\cr
\otimes\cr
((S \otimes 1(\ldots)) \circ \tx{Inst}_C(\mathcal{Q}'))
\end{matrix}
=
\begin{pmatrix}
1(\tx{Out}(\tx{Inst}_{C'}(\mathcal{P})))\cr
\otimes\cr
S\cr
\otimes\cr
1(\tx{Out}(\tx{Inst}_C(\mathcal{Q})) / \tx{Out}(S))
\end{pmatrix}
\circ
\begin{pmatrix}
  \tx{Inst}_{C'}(\mathcal{P})\cr
  \otimes\cr
  \tx{Inst}_{C}(\mathcal{Q}')
\end{pmatrix}
$$
Applying concurrent breakdown in reverse, we get that the right hand
side is $\tx{Inst}_{C'}(\mathcal{P} \otimes \mathcal{Q})$,
and that the left hand side is the simulator showing
that $\mathcal{P} \otimes \mathcal{Q} \overset{\epsilon}{\leadsto}_{\mathcal{C}'} \mathcal{P} \otimes \mathcal{Q}'$.
The left hand side is a valid simulator because
$\tx{Out}(\tx{Inst}_C(\mathcal{Q})) = \tx{Out}(\tx{Inst}_{C'}(\mathcal{Q}))$,
and all of the honest parts of $\mathcal{P}$ are left untouched,
since all of it is.

$\blacksquare$
\end{theorem}

\begin{theorem}[Horizontal Composition Theorem]
  \label{thm:horizontal_composition_theorem}
  For any protocols $\mathcal{P}, \mathcal{Q}$ with $\mathcal{P} \lhd \mathcal{Q}$
  well defined and closed, and for any compatible corruption classes $\mathcal{C}, \mathcal{C'}$, we have:
  \begin{enumerate}
    \item $\mathcal{Q} =_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \lhd \mathcal{Q} =_{\mathcal{C}'} \mathcal{P} \lhd \mathcal{Q}'$
    \item $\mathcal{Q} \overset{\epsilon}{\approx}_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \lhd \mathcal{Q} \overset{\epsilon}{\approx}_{\mathcal{C}'} \mathcal{P} \lhd \mathcal{Q}'$
  \end{enumerate}

  Furthermore, if $\mathcal{C}'$ is \emph{strictly} compatible with $\mathcal{C}$,
  we have:
  \begin{enumerate}
    \setcounter{enumi}{2}
    \item $\mathcal{Q} \overset{\epsilon}{\leadsto}_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \lhd \mathcal{Q} \overset{\epsilon}{\leadsto}_{\mathcal{C}'} \mathcal{P} \lhd \mathcal{Q}'$
  \end{enumerate}

  \txbf{Proof:} As one might expect,
  Theorem~\ref{thm:horizontal_breakdown}(horizontal breakdown)
  will be critical to proving each of these statements.

  One crude summary of the theorem, in the case
  that the protocols are closed, is that given compatible
  corruption models $C, C'$, there's a system $\tx{Stuff}$ such that
  $$
  \tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}) = \tx{Stuff} \circ \tx{Inst}_C(\mathcal{Q})
  $$
  This summary suffices to prove a couple statements already.

  \txbf{1.} By assumption, for any $C' \in \mathcal{C}'$,
  there exists a compatible $C \in \mathcal{C}$.
  In this case, we have:
  $$
  \tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}) = \tx{Sutff} \circ \tx{Inst}_C(\mathcal{Q})
  $$
  If we then apply $\mathcal{Q} =_{\mathcal{C}} \mathcal{Q}'$,
  we get:
  $$
  \tx{Stuff} \circ \tx{Inst}_C(\mathcal{Q}) = \tx{Stuff} \circ \tx{Inst}_C(\mathcal{Q}')
  $$
  and then, applying breakdown in reverse, we end up with $\tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}')$,
  completing our proof.

  \txbf{2.} We apply the same reasoning, with the difference that:
  $$
  \tx{Stuff} \circ \tx{Inst}_C(\mathcal{Q}) \overset{\epsilon}{\approx} \tx{Stuff} \circ \tx{Inst}_C(\mathcal{Q}')
  $$
  rather than being strictly equal.

  \txbf{3.} At this point our crude summary of the breakdown theorem is not
  sufficient anymore.
  We start with the same reasoning.
  For any $C' \in \mathcal{C}'$, there exists a \emph{strictly}
  compatible $C \in \mathcal{C}$, and we have:
  $$
  \tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}) = \tx{Stuff} \circ \tx{Inst}_C(\mathcal{Q})
  $$
  then, we apply our assumption that $\mathcal{Q} \overset{\epsilon}{\leadsto}_{\mathcal{C}} \mathcal{Q}'$,
  giving us:
  $$
  \tx{Stuff} \circ \tx{Inst}_C(\mathcal{Q}) \overset{\epsilon}{\approx} \tx{Stuff} \circ (S \otimes 1(\ldots)) \circ \tx{Inst}_C(\mathcal{Q})
  $$
  Our strategy will be to rearrange the right hand side to get
  $$
  {(S' \otimes 1(\ldots)) \circ \tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}')}
  $$
  We start by unrolling $\tx{Stuff}$, using strict compatability, to get:
  $$
  1(O)\circ
  \begin{pmatrix}
    {\displaystyle \bigast}_{i \in [\mathcal{P}.n]} \tx{Routed}(\tx{Corrupt}'_{C'}(\mathcal{P}.P_i))
    \cr
    *\cr
    \mathcal{R}_{\mathcal{P}}\cr
    \otimes\cr
    1(\tx{Leakage}, L_{\mathcal{Q}'})
  \end{pmatrix}
  \circ
  \begin{pmatrix}
    \mathcal{P}.F\cr
    \otimes\cr
    1(\tx{Out}(\mathcal{R}_q))\cr
    \otimes\cr
    1(\mathcal{Q}'.\tx{Leakage})\cr
    \otimes\cr
    \bigotimes_{i \in [\mathcal{Q}'.n]} 1_i\cr
  \end{pmatrix}
  \circ
  \begin{pmatrix}
    S\cr
    \otimes\cr
    1(O_{\bar{S}})
  \end{pmatrix}
  \circ
  \tx{Inst}_C(\mathcal{Q}')
  $$
  with $O_{\bar{S}} := \tx{Out}(\tx{Inst}_C(\mathcal{Q}')) / \tx{Out}(S)$,
  and with each $1_i := 1(\tx{Out}(\tx{Inst}_C(\mathcal{Q}'.P_i)))$.
  we can apply interchange a few times to get:
  $$
  \footnotesize
  1(O) \circ
  \begin{pmatrix}
    \begin{pmatrix}
    {\displaystyle \bigast_{C'_i \neq \tx{H}}}
    \begin{pmatrix}
      \tx{Routed}(\tx{Corrupt}'_{C'}(\mathcal{P}.P_i))\cr
      \otimes\cr
      1(L_i)
    \end{pmatrix}\cr
    \otimes\cr
    1(\tx{Leakage})
    \end{pmatrix}
    \circ
    \begin{pmatrix}
      S\cr
      \otimes\cr
      1(O_S)
    \end{pmatrix}
    \circ
    \begin{pmatrix}
    {\displaystyle \bigast_{C_i \neq \tx{H}}}
    \tx{Routed}(\tx{Corrupt}_C(\mathcal{Q}'.P_i))
    \cr
    \otimes\cr
    1(\tx{Out}(\mathcal{P}.F), \tx{Out}(\mathcal{Q}.F))
    \end{pmatrix}
    \cr
    *\cr
    {\displaystyle \bigast_{C'_i = \tx{H}}}
    \tx{Routed}(\tx{Corrupt}_{C'}((\mathcal{P} \lhd \mathcal{Q}').P_i))\cr
    *\cr
    \mathcal{R}_{\mathcal{P}} \circ \mathcal{R}_{\mathcal{Q}'}\cr
  \end{pmatrix}
  \circ
  \begin{pmatrix}
    \mathcal{P}.F\cr
    \otimes\cr
    \mathcal{Q}'.F
  \end{pmatrix}
  $$
  with $O_S := O_{\bar{S}} \cup \tx{Out}(\mathcal{P}.F)$ and $L_i$ as per the horizontal breakdown theorem.
  The only functions that $S$ masks are the leakage, the malicious corruption
  functions, and the logs from semi-honest corruption.
  Semi-honest corruption does not use any outputs of $S$,
  instead relying on the $\mathcal{Q}'.P_i$, accessible via $1(O_S)$.
  In the case of malicious corruption, since $\tx{Corrupt}'_{C'}(\mathcal{P}.P_i)$
  omits the $\tx{Call}_{F_i}$ functions, the system also has no dependencies
  on the output of $S$.
  Since none of these corrupted players depend on $S$,
  we can slide it forward, using interchange, to get:
  $$
  \footnotesize
  1(O) \circ
  \begin{pmatrix}
    \begin{pmatrix}
      S\cr
      \otimes\cr
      1(\ldots)
    \end{pmatrix}
    \circ
    \begin{pmatrix}
    {\displaystyle \bigast_{C'_i \neq \tx{H}}}
    \begin{pmatrix}
      \tx{Routed}(\tx{Corrupt}'_{C'}(\mathcal{P}.P_i))\cr
      \otimes\cr
      1(L_i)
    \end{pmatrix}\cr
    \otimes\cr
    1(\tx{Leakage})
    \end{pmatrix}
    \circ
    \begin{pmatrix}
    {\displaystyle \bigast_{C_i \neq \tx{H}}}
    \tx{Routed}(\tx{Corrupt}_C(\mathcal{Q}'.P_i))
    \cr
    \otimes\cr
    1(\tx{Out}(\mathcal{P}.F), \tx{Out}(\mathcal{Q}.F))
    \end{pmatrix}
    \cr
    *\cr
    {\displaystyle \bigast_{C'_i = \tx{H}}}
    \tx{Routed}(\tx{Corrupt}_{C'}((\mathcal{P} \lhd \mathcal{Q}').P_i))\cr
    *\cr
    \mathcal{R}_{\mathcal{P}} \circ \mathcal{R}_{\mathcal{Q}'}\cr
  \end{pmatrix}
  \circ
  \begin{pmatrix}
    \mathcal{P}.F\cr
    \otimes\cr
    \mathcal{Q}'.F
  \end{pmatrix}
  $$
  which becomes:
  $$
  \begin{pmatrix}
    S\cr
    \otimes\cr
    1(\tx{Out}(\tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}')) / \tx{Out}(S))
  \end{pmatrix}
  \circ
  \tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q}')
  $$

  From this chain of equalities we conclude that
  $\mathcal{P} \lhd \mathcal{Q}' \overset{\epsilon}{\leadsto} \mathcal{P} \lhd \mathcal{Q}'$

  $\blacksquare$
\end{theorem}

\subsection{Global Functionalities}

\begin{definition}[Relatively Closed Protocols]
  A protocol $\mathcal{P}$ is \emph{closed relative to} a game $G$
  if:
  \begin{itemize}
    \item $\tx{In}(\mathcal{P}) = \emptyset$
    \item $\tx{IdealIn}(\mathcal{P}) \subseteq \tx{Out}(G)$
  \end{itemize} 

  $\square$
\end{definition}
\begin{definition}[Relative Instantiation]
  Given a closed protocol $\mathcal{P}$ relative to $G$, we can define,
  for any corruption model $C$,
  the relative instantiation:
  $$
  \tx{Inst}_{C}^G(\mathcal{P}) :=
  \begin{pmatrix}
    \tx{Inst}_C(\mathcal{P})\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ G
  $$

  We can also extend this to the case of simulated instantiation,
  defining, for any simulator $S$:
  $$
  \tx{SimInst}_{S, C}^G(\mathcal{P}) :=
  \begin{pmatrix}
    \tx{SimInst}_{S, C}(\mathcal{P})\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ G
  $$

  $\square$
\end{definition}

\begin{definition}[Relative Notions of Equality]
  Given closed protocols $\mathcal{P}, \mathcal{Q}$ relative to $G$,
  with the same shape, and a corruption class $\mathcal{C}$
  for these protocols, we define:
  \begin{itemize}
    \item $\mathcal{P} =^G_{\mathcal{C}} \mathcal{Q} \iff \forall C \in \mathcal{C}.\ \tx{Inst}^G_C(\mathcal{P}) = \tx{Inst}^G_C(\mathcal{Q})$
    \item $\mathcal{P} \overset{\epsilon}{\approx}^G_{\mathcal{C}} \mathcal{Q}\iff \forall C \in \mathcal{C}.\ \tx{Inst}^G_C(\mathcal{P}) \overset{\epsilon}{\approx} \tx{Inst}^G_C(\mathcal{Q})$
    \item $\mathcal{P} \overset{\epsilon}{\leadsto}^G_{\mathcal{C}} \mathcal{Q}\iff \forall C \in \mathcal{C}.\ \exists S.\ \tx{Inst}^G_C(\mathcal{P}) \overset{\epsilon}{\approx} \tx{SimInst}^G_{S,C}(\mathcal{Q})$
  \end{itemize}

  $\square$
\end{definition}

\begin{theorem}[Relative Equality Hierarchy]
  For any corruption class $\mathcal{C}$ and game $G$, we have:
\begin{enumerate}
\item $\mathcal{P} =^G_{\mathcal{C}} \mathcal{Q} \implies \mathcal{P} \overset{0}{\approx}^G_\mathcal{C} \mathcal{Q}$.
\item $\mathcal{P} \overset{\epsilon}{\approx}^G_{\mathcal{C}} \mathcal{Q} \implies \mathcal{P} \overset{\epsilon}{\leadsto}^G_\mathcal{C} \mathcal{Q}$.
\end{enumerate}
\txbf{Proof:}

\txbf{1.} This follows from the fact that $A = B \implies A \overset{0}{\approx} B$
for any systems $A, B$.

\txbf{2.} In the proof of Theorem~\ref{thm:equality_hierarchy},
we used the existence of a simulator $S$ such that $\tx{SimInst}_{S, C}(\mathcal{P}) = \tx{Inst}_C(\mathcal{P})$.
This simulator will also satisfy $\tx{SimInst}^G_{S, C}(\mathcal{P}) = \tx{Inst}^G_C(\mathcal{P})$,
and can thus be used directly to prove this relation.

$\blacksquare$
\end{theorem}

\begin{theorem}[Transitivity of Relative Equality]
  \label{thm:trans_relative_equality}
  For any protocols $\mathcal{L}$, $\mathcal{P}$, $\mathcal{Q}$
  closed relative to a game $G$, and for any corruption class, we have:
  \begin{enumerate}
    \item $\mathcal{L} =_{\mathcal{C}}^G \mathcal{P}, \mathcal{P} =_{\mathcal{C}}^G \mathcal{Q} \implies \mathcal{L} =_{\mathcal{C}}^G \mathcal{Q}$,
    \item $\mathcal{L} \overset{\epsilon_1}{\approx}_{\mathcal{C}}^G \mathcal{P}, \mathcal{P} \overset{\epsilon_2}{\approx}_{\mathcal{C}}^G \mathcal{Q} \implies \mathcal{L} \overset{\epsilon_1 + \epsilon_2}{\approx}_{\mathcal{C}}^G \mathcal{Q}$,
    \item $\mathcal{L} \overset{\epsilon_1}{\leadsto}_{\mathcal{C}}^G \mathcal{P}, \mathcal{P} \overset{\epsilon_2}{\leadsto}_{\mathcal{C}}^G \mathcal{Q} \implies \mathcal{L} \overset{\epsilon_1 + \epsilon_2}{\leadsto}_{\mathcal{C}}^G \mathcal{Q}$.
  \end{enumerate}

  \txbf{Proof:} Once again, the first two parts follow directly from Lemma~\ref{thm:system_trans},
  by considering the systems $\tx{Inst}^G_C(\mathcal{L})$, $\tx{Inst}^G_C(\mathcal{P})$,
  $\tx{Inst}^G_C(\mathcal{Q})$ for any $C \in \mathcal{C}$.

  For part 3, given any $C \in \mathcal{C}$, there exists $S_1, S_2$ such that:
  \begin{itemize}
    \item $\tx{Inst}^G_C(\mathcal{L}) \overset{\epsilon_1}{\approx} \tx{SimInst}^G_{S_1, C}(\mathcal{P})$,
    \item $\tx{Inst}^G_C(\mathcal{P}) \overset{\epsilon_2}{\approx} \tx{SimInst}^G_{S_2, C}(\mathcal{Q})$.
  \end{itemize}
  Next, observe that for any protocol $\mathcal{P}$, we can write:
  $$
  \tx{SimInst}^G_C =
  \begin{pmatrix}
    S\cr
    \otimes\cr
    1(O)
  \end{pmatrix}
  \circ
  \tx{Inst}^G_C(\mathcal{P})
  $$
  where $O = \tx{Out}(\tx{Inst}_C(\mathcal{P})) / \tx{Out}(S) \cup \tx{Out}(G)$.

  We then apply transitivity for systems and interchange get:
  $$
  \tx{Inst}^G_C(\mathcal{L}) \overset{\epsilon_1 + \epsilon_2}{\approx}
  \begin{pmatrix}
    S_1 \circ S_2\cr
    \otimes\cr
    1(O)
  \end{pmatrix}
  \circ
  \tx{Inst}^G_C(\mathcal{Q})
  $$
  And the left side is simply $\tx{SimInst}^G_{(S_1 \circ S_2), C}(\mathcal{Q})$,
  concluding our proof.

  $\blacksquare$
\end{theorem}

\begin{theorem}[Global Malicious Completeness]
  Let $\mathcal{P}$ and $\mathcal{Q}$ closed protocols relative to $G$ with the same shape.
  Given any class of corruptions $\mathcal{C}$, let $\mathcal{C}'$ be a related class, containing
  models in $\mathcal{C}$ with some
  malicious corruptions replaced with semi-honest corruptions.
  We then have:
  \begin{enumerate}
    \item $\mathcal{P} =^G_{C} \mathcal{Q} \implies \mathcal{P} =^G_{C'} \mathcal{Q}$,
    \item $\mathcal{P} \overset{\epsilon}{\approx}^G_{C} \mathcal{Q} \implies \mathcal{P} \overset{\epsilon}{\approx}^G_{C'} \mathcal{Q}$,
  \end{enumerate}

  \txbf{Proof:} We proceed similarly to Theorem~\ref{thm:mal_complete} (malicious completeness).
  In that theorem, the key observation was that for any $C' \in \mathcal{C}'$
  and the related $C \in \mathcal{C}$, it holds that:
  $$
  \tx{Inst}_{C'}(\mathcal{P}) = \tx{SimInst}_{S_{\tx{SH}}, C}(\mathcal{P})
  $$
  (this observation also doesn't depend on $\mathcal{P}$ being fully closed,
  allowing us to use it here).

  Now, this clearly implies that:
  $$
  \tx{Inst}_{C'}^G(\mathcal{P}) = \tx{SimInst}^G_{S_{\tx{SH}}, C}(\mathcal{P})
  $$
  And then, using our observation from Theorem~\ref{thm:trans_relative_equality},
  we can write this as:
  $$
  \tx{Inst}_{C'}^G(\mathcal{P}) =
  \begin{pmatrix}
    S_{\tx{SH}}\cr
    \otimes\cr
    1(O)
  \end{pmatrix}
  \circ
  \tx{Inst}^G_C(\mathcal{P})
  $$
  where $O = \tx{Out}(\tx{Inst}_C(\mathcal{P})) / \tx{Out}(S) \cup \tx{Out}(G)$.

  This immediately implies parts 1 and 2.

  $\blacksquare$
\end{theorem}

\begin{theorem}[Global Vertical Composition Theorem]
  For any protocol $\mathcal{P}$ and game $F$, such that $\mathcal{P} \circ F$
  is well defined and closed relative to $G$, and for any corruption class $\mathcal{C}$, we have:
  \begin{enumerate}
    \item $F = F' \implies \mathcal{P} \circ F =^G_{\mathcal{C}} \mathcal{P} \circ F'$
    \item $F \overset{\epsilon}{\approx} F' \implies \mathcal{P} \circ F \overset{\epsilon}{\approx}^G_{\mathcal{C}} \mathcal{P} \circ F'$
  \end{enumerate}

  \txbf{Proof:} The proof of Theorem~\ref{thm:vertical_composition_theorem} will be the basis
  for what we do here.
  Using it, we can write:
  $$
  \tx{Inst}^G_C(\mathcal{P} \circ F) =
  \begin{pmatrix}
    A \circ F\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ G
  $$
  for some system $A$.
  At this point, the theorem immediately holds, since $\circ$ and $\otimes$ (for systems)
  respect both $=$ and $\approx$.

  $\blacksquare$
\end{theorem}

\begin{theorem}[Global Concurrent Composition Theorem]
  Let $\mathcal{P}, \mathcal{Q}$ be closed protocols relative to $G$, with $\mathcal{P} \otimes \mathcal{Q}$
  well defined. For any compatible corruption classes $\mathcal{C}, \mathcal{C}'$
  it holds that:
  \begin{enumerate}
    \item $\mathcal{Q} =^G_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \otimes \mathcal{Q} =^G_{\mathcal{C}'} \mathcal{P} \otimes \mathcal{Q}'$
    \item $\mathcal{Q} \overset{\epsilon}{\approx}^G_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \otimes \mathcal{Q} \overset{\epsilon}{\approx}^G_{\mathcal{C}'} \mathcal{P} \otimes \mathcal{Q}'$
    \item $\mathcal{Q} \overset{\epsilon}{\leadsto}^G_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \otimes \mathcal{Q} \overset{\epsilon}{\leadsto}^G_{\mathcal{C}'} \mathcal{P} \otimes \mathcal{Q}'$
  \end{enumerate}

  \txbf{Proof:} We start by using Theorem~\ref{thm:concurrent_breakdown}, giving us:
  $$
  \tx{Inst}^G_{C'}(\mathcal{P} \otimes \mathcal{Q})
  =
  \begin{pmatrix}
    \tx{Inst}_{C'}(\mathcal{P})\cr
    \otimes\cr
    \tx{Inst}_C(\mathcal{Q})\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ G
  =
  \begin{pmatrix}
    \tx{Inst}_{C'}(\mathcal{P})\cr
    \otimes\cr
    1(\tx{Out}(\tx{Inst}_C(\mathcal{Q})))\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ
  \tx{Inst}^G_C(\mathcal{Q})
  $$
  We can then immediately derive parts 1 and 2.

  For part 3, we apply the hypothesis to the last part of the above relation, to get:
  $$
  \tx{Inst}^G_{C'} \overset{\epsilon}{\approx}
  \begin{pmatrix}
    \tx{Inst}_{C'}(\mathcal{P})\cr
    \otimes\cr
    1(\tx{Out}(\tx{Inst}_C(\mathcal{Q})))\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ
  \tx{SimInst}^G_{S, C}(\mathcal{Q})
  $$
  Then, we unroll $\tx{SimInst}^G_{S, C}(\mathcal{Q})$, to get:
  $$
  \begin{pmatrix}
    \tx{Inst}_{C'}(\mathcal{P})\cr
    \otimes\cr
    1(\tx{Out}(\tx{Inst}_C(\mathcal{Q})))\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ
  \begin{pmatrix}
    \begin{pmatrix}
      S\cr
      \otimes\cr
      1(\ldots)\cr
    \end{pmatrix}
    \circ \tx{Inst}_C(\mathcal{Q})\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ G
  $$
  Then, we apply interchange to get:
  $$
  \begin{pmatrix}
    \begin{pmatrix}
      1(\ldots)\cr
      \otimes\cr
      S\cr
      \otimes\cr
      1(\ldots)\cr
    \end{pmatrix}
    \circ
    \begin{pmatrix}
    \tx{Inst}_{C'}(\mathcal{P})\cr
    \otimes\cr
    \tx{Inst}_C(\mathcal{Q})\cr
    \end{pmatrix}\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ G
  $$
  But this is just $\tx{SimInst}^G_{S', C'}(\mathcal{P} \otimes \mathcal{Q})$,
  for some simulator $S'$,
  applying concurrent breakdown in reverse.

  $\blacksquare$
\end{theorem}

\begin{theorem}[Global Horizontal Composition Theorem]
  For any protocols $\mathcal{P}, \mathcal{Q}$ closed relative to $G$, with $\mathcal{P} \lhd \mathcal{Q}$
  well defined, and for any compatible corruption classes $\mathcal{C}, \mathcal{C'}$, we have:
  \begin{enumerate}
    \item $\mathcal{Q} =^G_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \lhd \mathcal{Q} =^G_{\mathcal{C}'} \mathcal{P} \lhd \mathcal{Q}'$
    \item $\mathcal{Q} \overset{\epsilon}{\approx}^G_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \lhd \mathcal{Q} \overset{\epsilon}{\approx}^G_{\mathcal{C}'} \mathcal{P} \lhd \mathcal{Q}'$
  \end{enumerate}

  Furthermore, if $\mathcal{C}'$ is \emph{strictly} compatible with $\mathcal{C}$,
  we have:
  \begin{enumerate}
    \setcounter{enumi}{2}
    \item $\mathcal{Q} \overset{\epsilon}{\leadsto}^G_{\mathcal{C}} \mathcal{Q}' \implies \mathcal{P} \lhd \mathcal{Q} \overset{\epsilon}{\leadsto}^G_{\mathcal{C}'} \mathcal{P} \lhd \mathcal{Q}'$
  \end{enumerate}

  \txbf{Proof:} This proof is similar to that of Theorem~\ref{thm:horizontal_composition_theorem}.
  By compatability, for any $C' \in \mathcal{C}'$, we have a compatible $C \in \mathcal{C}$.

  A crude summary of the horizontal breakdown theorem is that:
  $$
  \tx{Inst}_{C'}(\mathcal{P} \lhd \mathcal{Q})
  = \tx{Stuff} \circ \begin{pmatrix}
    \tx{Inst}_C(\mathcal{Q})\cr
    \otimes\cr
    1(\tx{In}(\mathcal{P}.F))
  \end{pmatrix}
  $$
  Using the fact that being closed relative to $G$ means $\tx{In}(\mathcal{P}.F) \subseteq \tx{Out}(G)$,
  we get:
  $$
  \tx{Inst}^G_{C'}(\mathcal{P} \lhd \mathcal{Q}) =
  \begin{pmatrix}
    \tx{Stuff}\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ \tx{Inst}^G_C(\mathcal{Q})
  $$
  Part 1 and 2 both follow immediately from this decomposition.

  For part 3, we dig a bit deeper into the proof of Theorem~\ref{thm:horizontal_composition_theorem}.
  In that proof, it was actually shown that:
  $$
  \tx{Stuff} \circ \tx{SimInst}_{S, C}(\mathcal{Q}') = \tx{SimInst}_{S', C'}(\mathcal{P} \lhd \mathcal{Q}')
  $$
  for some appropriate simulator $S'$.

  We can start to apply this, first by using our hypothesis:
  $$
  \tx{Inst}^G_{C'}(\mathcal{P} \lhd \mathcal{Q}) =
  \begin{pmatrix}
    \tx{Stuff}\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ \tx{Inst}^G_C(\mathcal{Q})
  \overset{\epsilon}{\approx}
  \begin{pmatrix}
    \tx{Stuff}\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ \tx{SimInst}^G_C(\mathcal{Q}')
  $$
  Next, we unroll the right side, to get:
  $$
  \begin{pmatrix}
    \tx{Stuff}\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ
  \begin{pmatrix}
    \tx{SimInst}_{S, C}(\mathcal{Q}')\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ
  G
  $$
  Then, apply interchange, to get:
  $$
  \begin{pmatrix}
    \tx{Stuff} \circ \tx{SimInst}_{S, C}(\mathcal{Q}')\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ
  G
  $$
  And finally, apply the fact we dug up above, to get:
  $$
  \begin{pmatrix}
    \tx{SimInst}_{S', C'}(\mathcal{P} \lhd \mathcal{Q})\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ
  G
  $$
  which is none other than $\tx{SimInst}^G_{S', C'}(\mathcal{P} \lhd \mathcal{Q})$.

  $\blacksquare$
\end{theorem}

\subsection{Hopping Ideal Functionalities}

\begin{lemma}[Deidealization Lemma]
  Given a closed protocol $\mathcal{P}$ with an ideal functionality $F \otimes G$,
  there exists protocols $\mathcal{P}'$ and $\mathcal{G}$
  such that:
  $$
  \mathcal{P} \equiv \mathcal{P}' \lhd \mathcal{G}
  $$
  and $\mathcal{P}'$ has ideal functionality $F$.


  \txbf{Proof:} The players of $\mathcal{P}'$ are those of $\mathcal{P}$,
  except that each $P_i$'s call to a function $g \in \tx{Out}(G)$ is replaced with
  a renamed function $g_i$.
  $\mathcal{G}$ will have one player for each player in $\mathcal{P}'$.
  Each player $\mathcal{G}.P_i$ exports a function $g_i$ for each input
  $g_i$ of $\mathcal{P}'.P_i$, which immediately calls $g \in \tx{Out}(G)$,
  and returns the result.
  From this definition, it's clear that $\mathcal{P}$ is literally equal
  to $\mathcal{P}' \lhd \mathcal{G}$, as when the players in the latter
  are formed, the calls to the intermediate $g_i$ disappear,
  with each player calling $g \in \tx{Out}(G)$ directly

  $\blacksquare$
\end{lemma}

\begin{lemma}[Embedding Lemma]
  Given a protocol $\mathcal{P}$ closed relative to a game $G$,
  there exists a protocol $\tx{Embed}_G(\mathcal{P})$ such that for any
  corruption model $C$, we have:
  $$
  \tx{Inst}^G_C(\mathcal{P}) = \tx{Inst}_C(\tx{Embed}_G(\mathcal{P}))
  $$

  \txbf{Proof:}
  This one is quite simple. $\tx{Embed}_G(\mathcal{P})$ has the same players
  as $\mathcal{P}$, with the ideal functionality becoming:
  $$
  \begin{pmatrix}
    \mathcal{P}.F\cr
    \otimes\cr
    1(\tx{Out}(G))
  \end{pmatrix}
  \circ G
  $$
  and the leakage being $\mathcal{P}.\tx{Leakage} \cup \tx{Out}(G)$.
  The two instantiations will then clearly be equal under any corruption model.

  $\blacksquare$
\end{lemma}

\subsection{Some Syntactical Conventions}
