\section{Protocols and Composition}

\begin{definition}[Open Protocols]
An \emph{open protocol} $\mathcal{P}$ consists of:
\begin{itemize}
\item Systems $P_1, \ldots, P_n$, called \emph{players}
\item A package $F$, called the \emph{ideal functionality}
\end{itemize}

Furthermore, we also impose requirements on the channels and functions
these elements use.

First, we require that the player systems are jointly closed,
with no extra channels that aren't connected to other players:
$$
\bigcup_{i \in [n]} \text{OutChan}(P_i) = \bigcup_{i \in [n]} \text{InChan}(P_i)
$$

Second, we require that the functions the systems depend on are disjoint:
$$
\forall i, j \in [n].\quad \text{In}(P_i) \cap \text{In}(P_j) = \emptyset
$$

We can also define a few convenient notations related to the interface of a base
protocol.

Let $\text{Out}_i(\mathcal{P}) := \text{Out}(P_i)$, and let $\text{In}_i(\mathcal{P}) := \text{In}(P_i) / \text{Out}(F)$.
We then define $\text{Out}(\mathcal{P}) := \bigcup_{i \in [n]} \text{Out}_i(\mathcal{P})$
and $\text{In}(\mathcal{P}) := \bigcup_{i \in [n]} \text{In}_i(\mathcal{P})$.
Finally, we define $\text{IdealIn}(\mathcal{P}) := \text{In}(F)$.

$\square$
\end{definition}

\begin{definition}[Vertical Composition]
Given an open protocol $\mathcal{P}$ and a package $G$, satisfying
$\text{IdealIn}(\mathcal{P}) \subseteq \text{Out}(G)$,
we can define the open protocol $\mathcal{P} \circ G$.

$\mathcal{P} \circ G$ has the same players as $\mathcal{P}$,
but its ideal functionality $F$ becomes $F \circ G$.

$\square$
\end{definition}

\begin{definition}[Horizontal Composition]
Given two open protocols $\mathcal{P}, \mathcal{Q}$,
we can define the open protocol $\mathcal{P} \lhd \mathcal{Q}$,
provided a few requirements hold.

First, we need: $\text{In}(\mathcal{P}) \subseteq \text{Out}(\mathcal{Q})$.
We also require that the functions exposed by a player in $\mathcal{Q}$
are only used by at most one player in $\mathcal{P}$.
We express this as:
\[
\forall i \in [\mathcal{Q}.n].\ \nexists j \neq j' \in [\mathcal{P}.n].\quad \text{Out}_i \cap \text{In}_j \neq \emptyset \land \text{Out}_i \cap \text{In}_{j'} \neq \emptyset
\]

Second, we require that the players share no channels between the two
protocols.
In other words $\text{Chan}(\mathcal{P}.P_i) \cap \text{Chan}(\mathcal{Q}.P_j) = \emptyset$, for all $P_i, P_j$.

Finally, we require that the ideal functionalities do not overlap, 
  in the sense that $\text{Out}(\mathcal{P}.F) \cap \text{Out}(\mathcal{Q}.F) = \emptyset$

Our first condition has an interesting consequence: every player $\mathcal{Q}.P_j$
has its functions used by at most one player $\mathcal{P}.P_i$.
In that case, we say that $\mathcal{P}.P_i$ \emph{uses} $\mathcal{Q}.P_j$.

With this in hand, we can define $\mathcal{P} \lhd \mathcal{Q}$.

The players will consist of:
$$
  \mathcal{P}.P_i \circ \left( \bigast_{\mathcal{Q}.P_j \text{ used by } \mathcal{P}.P_i } \mathcal{Q}.P_j \right)
$$
Along with all of the $\mathcal{Q}.P_j$ which are not used by any
player in $\mathcal{P}$.

The ideal functionality is $\mathcal{P}.F \otimes \mathcal{Q}.F$.

We can also easily show that this definition is well defined, satisfying
the required properties of an open protocol.
Because of the definition of the players, we see that:
$$
  \bigcup_{i \in [(\mathcal{P} \lhd \mathcal{Q}).n]} \tx{OutChan}((\mathcal{P} \lhd \mathcal{Q}).{P_i})
  = \left(\bigcup_{i \in [\mathcal{P}.n]} \tx{OutChan}(\mathcal{P}.P_i)\right) \cup
  \left(\bigcup_{i \in [\mathcal{Q}.n]} \tx{OutChan}(\mathcal{Q}.P_i)\right)
$$
  since $\text{OutChan}(A \circ B) = \text{OutChan}(A \otimes B) = \text{OutChan}(A, B)$.
A similar reasoning applies to $\text{InChan}$, allowing us to conclude that:
$$
  \bigcup_{i \in [(\mathcal{P} \lhd \mathcal{Q}).n]} \tx{OutChan}((\mathcal{P} \lhd \mathcal{Q}).{P_i}) =
  \bigcup_{i \in [(\mathcal{P} \lhd \mathcal{Q}).n]} \tx{InChan}((\mathcal{P} \lhd \mathcal{Q}).{P_i})
$$
as required.

By definition, the dependencies $\text{In}$ of each player in $\mathcal{P} \lhd \mathcal{Q}$
are the union of several players in $\mathcal{Q}$, so disjointness property
continues to hold.

$\square$

\end{definition}
